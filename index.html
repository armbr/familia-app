<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fluxo App</title>
<style>
/* â”€â”€ RESET & BASE â”€â”€ */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{
  height:100%;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;
  font-size:16px;
  background:#0F1923;
  color:#EDF2F7;
}

/* â”€â”€ CSS VARS â”€â”€ */
:root{
  --bg:#0F1923;
  --bg2:#162030;
  --bg3:#1E2D40;
  --card:#1A2A3A;
  --card2:#213346;
  --border:rgba(255,255,255,0.08);
  --green:#2ECC9A;
  --green2:rgba(46,204,154,0.15);
  --red:#FF6B6B;
  --red2:rgba(255,107,107,0.15);
  --yellow:#FFD166;
  --yellow2:rgba(255,209,102,0.12);
  --blue:#5B9BD5;
  --blue2:rgba(91,155,213,0.15);
  --t1:#EDF2F7;
  --t2:#8FA8C4;
  --t3:#526680;
  --r:16px;
  --r2:12px;
}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:0;height:0}

/* â”€â”€ LAYOUT â”€â”€ */
#app{
  max-width:430px;
  min-height:100vh;
  margin:0 auto;
  background:var(--bg);
  position:relative;
  padding-bottom:80px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETUP SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#setup{
  position:fixed;
  inset:0;
  max-width:430px;
  margin:0 auto;
  background:#0F1923;
  z-index:9999;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:32px 24px;
  text-align:center;
}
#setup .ico{font-size:56px;margin-bottom:20px}
#setup h2{font-size:22px;font-weight:800;color:#EDF2F7;margin-bottom:8px}
#setup p{font-size:13px;color:#8FA8C4;margin-bottom:28px;line-height:1.6}
#setup input{
  width:100%;padding:13px 14px;
  background:#1E2D40;border:2px solid rgba(255,255,255,0.1);
  border-radius:12px;color:#EDF2F7;font-size:13px;
  font-family:inherit;outline:none;margin-bottom:10px;
  transition:border-color .2s;
}
#setup input:focus{border-color:#2ECC9A}
#setup button{
  width:100%;padding:14px;
  background:#2ECC9A;border:none;border-radius:12px;
  color:#0A1A12;font-size:15px;font-weight:800;
  font-family:inherit;cursor:pointer;margin-bottom:10px;
}
#setup .note{
  font-size:11px;color:#526680;line-height:1.7;
  background:#1E2D40;border-radius:12px;
  padding:14px;text-align:left;width:100%;
}
#setup .note b{color:#8FA8C4}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#hdr{
  position:sticky;top:0;z-index:100;
  background:var(--bg2);
  padding:14px 16px 14px;
  border-bottom:1px solid var(--border);
}
#hdr-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
#hdr-top .logo{font-size:12px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--t3)}
#hdr-top .right{display:flex;align-items:center;gap:8px}
#offline-badge{
  display:none;font-size:10px;font-weight:700;
  background:rgba(255,209,102,.12);border:1px solid rgba(255,209,102,.3);
  color:#FFD166;padding:3px 8px;border-radius:100px;
}
#month-chip{
  font-size:12px;font-weight:600;color:var(--t2);
  background:var(--card);padding:5px 11px;
  border-radius:100px;border:1px solid var(--border);
  text-transform:capitalize;
}
#sync-btn{
  background:var(--card);border:1px solid var(--border);
  color:var(--t2);font-size:12px;padding:5px 10px;
  border-radius:100px;cursor:pointer;font-family:inherit;
  font-weight:600;transition:all .2s;
}
#sync-btn.spinning{color:var(--green);border-color:var(--green);animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Balance card */
#bal{
  background:linear-gradient(135deg,#1E3A5F,#0F2438);
  border:1px solid rgba(91,155,213,.2);
  border-radius:var(--r);padding:18px;margin-bottom:14px;
}
#bal .lbl{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--t2);margin-bottom:5px}
#bal-val{font-size:32px;font-weight:800;letter-spacing:-1px;margin-bottom:14px}
#bal-val.neg{color:var(--red)}
#bal-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.bal-cell{background:rgba(255,255,255,.05);border-radius:10px;padding:9px 11px}
.bal-cell .bl{font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:3px}
.bl.inc{color:var(--green)}.bl.exp{color:var(--red)}
.bal-cell .bv{font-size:15px;font-weight:700}

/* Fin tabs */
#fin-tabs{display:flex;gap:5px}
.ftab{
  flex:1;padding:8px 2px;border:1px solid var(--border);
  background:var(--card);color:var(--t3);
  border-radius:10px;font-family:inherit;
  font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;
}
.ftab.on{background:var(--green);color:#0A1A12;border-color:var(--green)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTENT AREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#content{padding:0 14px}
.pg{display:none}
.pg.on{display:block}

/* Section label */
.slbl{
  font-size:10px;font-weight:700;letter-spacing:1.5px;
  text-transform:uppercase;color:var(--t3);
  padding:14px 0 8px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card{
  background:var(--card);border:1px solid var(--border);
  border-radius:var(--r);padding:15px;margin-bottom:8px;
}
.card-title{font-size:12px;font-weight:700;color:var(--t2);margin-bottom:12px}
.fl{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:4px}
input,select{
  width:100%;padding:10px 12px;
  background:var(--bg3);border:1.5px solid var(--border);
  border-radius:10px;color:var(--t1);
  font-family:inherit;font-size:14px;outline:none;
  transition:border-color .2s;
  -webkit-appearance:none;appearance:none;
}
input:focus,select:focus{border-color:var(--green)}
input[type=number]{font-weight:700}
select option{background:#1A2A3A}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
.r-wrap{position:relative}
.r-wrap::before{
  content:'R$';position:absolute;left:11px;top:50%;
  transform:translateY(-50%);font-size:12px;font-weight:700;
  color:var(--t3);pointer-events:none;z-index:1;
}
.r-wrap input{padding-left:36px}
.type-row{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px}
.ttype{
  padding:9px;border:1.5px solid var(--border);border-radius:10px;
  background:transparent;color:var(--t2);
  font-family:inherit;font-size:13px;font-weight:600;
  cursor:pointer;transition:all .2s;
  display:flex;align-items:center;justify-content:center;gap:5px;
}
.ttype.exp{background:var(--red2);border-color:var(--red);color:var(--red)}
.ttype.inc{background:var(--green2);border-color:var(--green);color:var(--green)}
.btn{
  width:100%;padding:13px;border:none;border-radius:10px;
  background:var(--green);color:#0A1A12;
  font-family:inherit;font-size:14px;font-weight:800;
  cursor:pointer;margin-top:4px;transition:opacity .2s,transform .1s;
}
.btn:active{transform:scale(.98);opacity:.9}
.btn:disabled{opacity:.45;cursor:not-allowed}

/* Collapsible form header */
.coll-hdr{
  display:flex;justify-content:space-between;align-items:center;
  cursor:pointer;margin-bottom:0;
}
.coll-arrow{font-size:16px;color:var(--t3);transition:transform .2s}
.coll-body{margin-top:12px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRANSACTION LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.txl{display:flex;flex-direction:column;gap:7px}
.txi{
  background:var(--card);border:1px solid var(--border);
  border-radius:10px;padding:12px 14px;
  display:flex;align-items:center;gap:10px;
  animation:up .2s ease both;overflow:hidden;
}
@keyframes up{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.txi-ico{
  width:38px;height:38px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:16px;flex-shrink:0;
}
.txi-ico.exp{background:var(--red2)}
.txi-ico.inc{background:var(--green2)}
.txi-info{flex:1;min-width:0;overflow:hidden}
.txi-desc{font-size:14px;font-weight:600;white-space:normal;word-break:break-word;margin-bottom:3px;line-height:1.3}
.txi-meta{font-size:11px;color:var(--t3);display:flex;gap:4px 8px;flex-wrap:wrap;align-items:center;margin-top:2px}
.txi-cat{background:var(--bg3);padding:1px 6px;border-radius:4px;font-weight:600}
.txi-val{font-size:14px;font-weight:800;flex-shrink:0;text-align:right}
.txi-val.exp{color:var(--red)}
.txi-val.inc{color:var(--green)}
.tdel{background:none;border:none;color:var(--t3);font-size:15px;cursor:pointer;padding:3px 5px;border-radius:7px;transition:color .2s}
.tdel:hover{color:var(--red)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CATEGORY SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.catl{display:flex;flex-direction:column;gap:7px}
.cati{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:11px 13px}
.cati-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
.cati-name{font-size:13px;font-weight:600}
.cati-amt{font-size:13px;font-weight:800;color:var(--red)}
.bar-bg{height:4px;background:var(--bg3);border-radius:100px;overflow:hidden}
.bar-fg{height:100%;border-radius:100px;background:linear-gradient(90deg,var(--red),#FF9A9A);transition:width .4s}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MONTH FILTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mfrow{display:flex;gap:5px;overflow-x:auto;padding:4px 0 8px}
.mfc{
  flex-shrink:0;padding:5px 13px;border:1.5px solid var(--border);
  border-radius:100px;background:transparent;color:var(--t2);
  font-family:inherit;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;
}
.mfc.on{background:var(--green2);border-color:var(--green);color:var(--green)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIEW TOGGLE (tasks + fin agenda)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.vtog{
  display:grid;grid-template-columns:repeat(4,1fr);gap:4px;
  background:var(--bg3);border-radius:10px;padding:4px;
  margin-bottom:12px;
}
.vbtn{
  padding:7px 3px;border:none;background:transparent;
  color:var(--t3);font-family:inherit;font-size:11px;
  font-weight:700;border-radius:8px;cursor:pointer;transition:all .2s;
}
.vbtn.on{background:var(--card2);color:var(--green)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALENDAR SHARED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.day-nav{
  display:flex;align-items:center;justify-content:space-between;
  background:var(--card);border:1px solid var(--border);
  border-radius:10px;padding:10px 13px;margin-bottom:10px;
}
.dnav-btn{background:none;border:none;color:var(--t2);font-size:22px;cursor:pointer;padding:2px 6px;border-radius:7px}
.dnav-lbl{text-align:center}
.dnav-date{font-size:14px;font-weight:800}
.dnav-sub{font-size:10px;color:var(--t3);margin-top:2px;letter-spacing:.5px;text-transform:uppercase}

.wnav{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.wnav-lbl{font-size:13px;font-weight:700;color:var(--t2)}
.wnav-btn{background:var(--card);border:1px solid var(--border);color:var(--t2);font-size:12px;padding:5px 11px;border-radius:8px;cursor:pointer;font-family:inherit;font-weight:600}

.wstrip{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:10px}
.wdc{display:flex;flex-direction:column;align-items:center;gap:3px}
.wdc-lbl{font-size:9px;font-weight:700;text-transform:uppercase;color:var(--t3)}
.wdc-num{
  width:28px;height:28px;border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:700;color:var(--t2);
  background:var(--bg3);cursor:pointer;transition:all .2s;
  border:1.5px solid transparent;
}
.wdc-num.today{background:var(--green2);color:var(--green);border-color:var(--green)}
.wdc-dots{display:flex;gap:2px;justify-content:center;min-height:6px}
.dot{width:4px;height:4px;border-radius:50%}

.mnav{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.mnav-lbl{font-size:14px;font-weight:800;text-transform:capitalize}
.mnav-btn{background:var(--card);border:1px solid var(--border);color:var(--t2);width:30px;height:30px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px}
.mgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:10px}
.mgh{font-size:9px;font-weight:700;text-transform:uppercase;color:var(--t3);text-align:center;padding:5px 0}
.mgc{
  aspect-ratio:1;border-radius:8px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  cursor:pointer;transition:all .2s;border:1.5px solid transparent;gap:1px;
}
.mgc:hover{background:var(--bg3)}
.mgc.today{background:var(--green2);border-color:var(--green)}
.mgc .mgn{font-size:11px;font-weight:700;color:var(--t2);line-height:1}
.mgc.today .mgn{color:var(--green)}
.mgc.om .mgn{color:var(--t3)}
.mgc-dots{display:flex;gap:2px;flex-wrap:wrap;justify-content:center;max-width:18px}

/* group label */
.glbl{
  font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  color:var(--t3);padding:12px 0 6px;display:flex;align-items:center;gap:6px;
}
.gbadge{background:var(--bg3);color:var(--t2);font-size:10px;font-weight:700;padding:1px 6px;border-radius:100px}
.g-overdue .glbl{color:var(--red)}
.g-today  .glbl{color:var(--green)}
.g-soon   .glbl{color:var(--yellow)}

/* bal mini */
.balmini{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:10px}
.bmc{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:9px 10px;text-align:center}
.bmc-l{font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:3px}
.bmc-l.i{color:var(--green)}.bmc-l.e{color:var(--red)}.bmc-l.b{color:var(--blue)}
.bmc-v{font-size:12px;font-weight:800}
.bmc-v.pos{color:var(--green)}.bmc-v.neg{color:var(--red)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TASK CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.taski{
  background:var(--card);border:1px solid var(--border);
  border-radius:10px;padding:12px 14px;margin-bottom:7px;
  animation:up .2s ease both;overflow:hidden;
}
.taski-hdr{display:flex;align-items:center;gap:9px;margin-bottom:8px;min-width:0}
.chk{
  width:28px;height:28px;border-radius:8px;
  border:2.5px solid var(--t3);flex-shrink:0;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .2s;background:transparent;font-size:14px;font-weight:900;color:#0A1A12;
  margin-top:1px;
}
.chk:active{transform:scale(.9)}
.chk.done{background:var(--green);border-color:var(--green);box-shadow:0 0 0 3px var(--green2)}
.tname{font-size:14px;font-weight:600;flex:1;line-height:1.4;min-width:0;word-break:break-word;overflow:hidden;}
.tname.done{text-decoration:line-through;color:var(--t3)}
.tdel2{background:none;border:none;color:var(--t3);font-size:14px;cursor:pointer;padding:2px 4px;border-radius:6px;flex-shrink:0;margin-left:4px}
.tmeta span{max-width:100%;word-break:break-word}
.tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:6px;align-items:center}
.tag{font-size:10px;font-weight:700;padding:2px 8px;border-radius:100px}
.tag.pend{background:var(--yellow2);color:var(--yellow)}
.tag.prog{background:var(--blue2);color:var(--blue)}
.tag.done{background:var(--green2);color:var(--green)}
.tag.texp{background:rgba(255,107,107,.13);color:var(--red)}
.tag.tinc{background:rgba(46,204,154,.13);color:var(--green)}
.tag.ttask{background:rgba(100,160,255,.13);color:#64A0FF}
.tag.trecur{background:rgba(160,100,255,.15);color:#A064FF;letter-spacing:.2px;
  cursor:pointer;border:none;font-family:inherit;font-size:10px;font-weight:700;
  padding:2px 8px;border-radius:100px;transition:background .15s}
.tag.trecur:active{background:rgba(160,100,255,.30)}
.tmeta{font-size:11px;color:var(--t3);display:flex;gap:6px 10px;flex-wrap:wrap;align-items:center;margin-top:4px}
.tmeta .ov{color:var(--red)}
.ssel{
  font-size:11px;padding:4px 9px;border-radius:7px;font-weight:600;
  background:var(--bg3);border-color:var(--border);color:var(--t1);
  cursor:pointer;width:auto;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RECORRÃŠNCIA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.recur-toggle{
  display:flex;align-items:center;gap:10px;
  background:var(--card);border:1px solid var(--border);
  border-radius:10px;padding:11px 14px;margin-top:8px;cursor:pointer;
  transition:border-color .2s;
}
.recur-toggle.on{border-color:var(--green);background:var(--green2);}
.recur-toggle-dot{
  width:22px;height:22px;border-radius:6px;border:2px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:12px;flex-shrink:0;transition:all .2s;
}
.recur-toggle.on .recur-toggle-dot{background:var(--green);border-color:var(--green);color:#0A1A12;}
.recur-toggle-lbl{font-size:13px;font-weight:600;color:var(--t2);}
.recur-toggle.on .recur-toggle-lbl{color:var(--green);}
.recur-badge{
  margin-left:auto;font-size:10px;font-weight:700;
  background:var(--bg3);color:var(--t3);padding:2px 7px;border-radius:100px;
}
.recur-toggle.on .recur-badge{background:rgba(46,204,154,.2);color:var(--green);}

.recur-card{
  background:var(--card);border:1px solid var(--border);
  border-radius:10px;padding:12px 14px;margin-bottom:7px;
  display:flex;align-items:center;gap:12px;
}
.recur-info{flex:1;min-width:0}
.recur-name{font-size:14px;font-weight:600;color:var(--t1);margin-bottom:3px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.recur-meta{font-size:11px;color:var(--t3);display:flex;gap:8px;flex-wrap:wrap;}
.recur-val{font-size:14px;font-weight:800;flex-shrink:0;}
.recur-val.exp{color:var(--red)}.recur-val.inc{color:var(--green)}
.recur-del{background:none;border:none;color:var(--t3);font-size:15px;cursor:pointer;padding:4px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPROVANTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.comprov-btn{
  display:flex;align-items:center;gap:8px;
  width:100%;padding:11px 14px;margin-top:6px;
  background:var(--card);border:1px solid var(--border);
  border-radius:10px;color:var(--t2);font-size:13px;font-weight:600;
  cursor:pointer;font-family:inherit;transition:border-color .2s;
}
.comprov-btn:active{border-color:var(--green)}
.comprov-picker{display:none;margin-top:6px;}
.comprov-picker input[type=file]{display:none}
.comprov-file-area{
  border:2px dashed var(--border);border-radius:10px;
  padding:20px;text-align:center;cursor:pointer;
  transition:border-color .2s;
}
.comprov-file-area:active{border-color:var(--green)}
.comprov-file-icon{font-size:32px;margin-bottom:8px}
.comprov-file-lbl{font-size:13px;color:var(--t2);font-weight:600;margin-bottom:4px}
.comprov-file-sub{font-size:11px;color:var(--t3)}
.comprov-preview{
  background:var(--card2);border:1px solid var(--border);
  border-radius:10px;padding:12px 14px;margin-top:8px;
  display:none;align-items:center;gap:10px;
}
.comprov-preview.show{display:flex}
.comprov-preview-info{flex:1;min-width:0}
.comprov-preview-name{font-size:13px;font-weight:600;color:var(--t1);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.comprov-preview-size{font-size:11px;color:var(--t3);margin-top:2px}
.comprov-upload-btn{
  padding:8px 14px;border-radius:8px;border:none;
  background:var(--green);color:#0A1A12;font-size:12px;
  font-weight:800;cursor:pointer;font-family:inherit;flex-shrink:0;
}
.comprov-progress{
  margin-top:8px;background:var(--bg3);border-radius:100px;
  height:4px;overflow:hidden;display:none;
}
.comprov-progress.show{display:block}
.comprov-progress-bar{
  height:100%;background:var(--green);border-radius:100px;
  width:0%;transition:width .3s;
}
.comprov-link{
  margin-top:8px;padding:10px 14px;background:var(--green2);
  border:1px solid var(--green);border-radius:10px;
  display:none;align-items:center;gap:8px;
}
.comprov-link.show{display:flex}
.comprov-link-url{flex:1;font-size:11px;color:var(--green);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.comprov-link-copy{
  padding:5px 10px;background:var(--green);color:#0A1A12;
  border:none;border-radius:6px;font-size:11px;font-weight:800;
  cursor:pointer;font-family:inherit;flex-shrink:0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOJE SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hoje-header{
  background:linear-gradient(135deg,#0F2438,#1E3A5F);
  border:1px solid rgba(91,155,213,.2);
  border-radius:var(--r,16px);padding:18px;margin:12px 0 14px;
}
.hoje-greeting{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:#8FA8C4;margin-bottom:4px}
.hoje-date{font-size:17px;font-weight:800;color:#EDF2F7;margin-bottom:14px;text-transform:capitalize}
.hoje-counters{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.hoje-counter{background:rgba(255,255,255,.06);border-radius:10px;padding:10px 8px;text-align:center}
.hoje-counter .hc-num{font-size:22px;font-weight:800;line-height:1}
.hoje-counter .hc-lbl{font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;margin-top:4px}
.hc-num.alert{color:#FF6B6B}
.hc-num.warn{color:#FFD166}
.hc-num.ok{color:#2ECC9A}

.hoje-section{margin-bottom:18px}
.hoje-section-title{
  font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
  color:#526680;padding:10px 0 8px;
  display:flex;align-items:center;justify-content:space-between;
}
.hoje-section-title .hst-badge{
  background:#1E2D40;color:#8FA8C4;
  font-size:10px;font-weight:700;padding:2px 8px;border-radius:100px;
}

/* cartÃ£o de pagamento */
.pgto-card{
  background:#1A2A3A;border:1px solid rgba(255,255,255,.08);
  border-radius:10px;padding:13px 14px;margin-bottom:7px;
  display:flex;align-items:center;gap:12px;
  animation:up .2s ease both;
}
.pgto-card.pago{opacity:.5}
.pgto-icon{
  width:40px;height:40px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:18px;flex-shrink:0;
}
.pgto-icon.exp{background:rgba(255,107,107,.15)}
.pgto-icon.inc{background:rgba(46,204,154,.15)}
.pgto-info{flex:1;min-width:0}
.pgto-desc{font-size:14px;font-weight:600;color:#EDF2F7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.pgto-meta{font-size:11px;color:#526680;display:flex;gap:6px;align-items:center}
.pgto-cat{background:#1E2D40;padding:1px 6px;border-radius:4px;font-weight:600}
.pgto-val{font-size:15px;font-weight:800;flex-shrink:0}
.pgto-val.exp{color:#FF6B6B}
.pgto-val.inc{color:#2ECC9A}
.pgto-chk{
  width:24px;height:24px;border-radius:7px;border:2px solid rgba(255,255,255,.12);
  flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .2s;background:transparent;font-size:12px;font-weight:800;color:#0A1A12;
}
.pgto-chk.pago{background:#2ECC9A;border-color:#2ECC9A}

.hoje-empty{text-align:center;padding:24px 12px;color:#526680}
.hoje-empty .he-icon{font-size:32px;margin-bottom:8px}
.hoje-empty .he-txt{font-size:13px;font-weight:600;color:#8FA8C4}

/* future planner */
.fmb{margin-bottom:18px}
.fmb-title{
  font-size:13px;font-weight:800;background:var(--card2);
  border:1px solid var(--border);border-radius:10px;
  padding:9px 13px;margin-bottom:7px;
  display:flex;justify-content:space-between;align-items:center;
}
.fproj{font-size:12px;font-weight:700}
.fproj.pos{color:var(--green)}.fproj.neg{color:var(--red)}
.fwr{
  background:var(--card);border:1px solid var(--border);
  border-radius:10px;padding:9px 13px;margin-bottom:5px;
  display:flex;justify-content:space-between;align-items:center;cursor:pointer;
}
.fwl{font-size:12px;font-weight:600;color:var(--t2)}
.fwa{display:flex;gap:9px;font-size:12px;font-weight:700}
.fwa .i{color:var(--green)}.fwa .e{color:var(--red)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty{text-align:center;padding:36px 16px;color:var(--t3)}
.empty .ei{font-size:38px;margin-bottom:10px}
.empty .et{font-size:14px;font-weight:600;color:var(--t2);margin-bottom:5px}
.empty .ed{font-size:12px;line-height:1.5}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#nav{
  position:fixed;bottom:0;left:50%;transform:translateX(-50%);
  width:100%;max-width:430px;
  background:var(--bg2);border-top:1px solid var(--border);
  display:flex;padding:8px 8px 12px;gap:4px;z-index:200;
}
.nb{
  flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;
  padding:7px 4px;border:none;background:none;color:var(--t3);
  font-family:inherit;font-size:10px;font-weight:700;
  letter-spacing:.3px;cursor:pointer;border-radius:10px;transition:all .2s;
}
.nb.on{color:var(--green);background:var(--green2)}
.nb .ni{font-size:19px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast{
  position:fixed;top:16px;left:50%;
  transform:translateX(-50%) translateY(-70px);
  font-weight:700;font-size:13px;
  padding:10px 18px;border-radius:100px;
  z-index:9000;transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  white-space:nowrap;box-shadow:0 6px 20px rgba(0,0,0,.4);
}
#toast.ok{background:var(--green);color:#0A1A12}
#toast.err{background:var(--red);color:#fff}
#toast.show{transform:translateX(-50%) translateY(0)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOCS SECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.docs-add{
  background:var(--card);border:1px solid var(--border);
  border-radius:var(--r,16px);padding:15px;margin:12px 0 8px;
}
.docs-add .coll-hdr{margin-bottom:0}
.docs-form{margin-top:12px;display:flex;flex-direction:column;gap:8px}
.docs-form .row2{margin-bottom:0}

.doc-card{
  background:var(--card);border:1px solid var(--border);
  border-radius:12px;padding:13px 14px;margin-bottom:7px;
  display:flex;align-items:center;gap:12px;
  cursor:pointer;transition:border-color .2s,transform .1s;
  text-decoration:none;
}
.doc-card:active{transform:scale(.98);border-color:var(--green)}
.doc-ico{
  width:42px;height:42px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;flex-shrink:0;
}
.doc-info{flex:1;min-width:0}
.doc-name{font-size:14px;font-weight:700;color:var(--t1);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:3px}
.doc-meta{font-size:11px;color:var(--t3);display:flex;gap:6px;align-items:center}
.doc-type-tag{
  font-size:10px;font-weight:700;padding:1px 7px;
  border-radius:100px;background:var(--bg3);color:var(--t2);
}
.doc-actions{display:flex;gap:6px;flex-shrink:0}
.doc-btn{
  background:none;border:1px solid var(--border);color:var(--t2);
  font-size:11px;font-weight:700;padding:5px 9px;border-radius:7px;
  cursor:pointer;transition:all .2s;font-family:inherit;
}
.doc-btn:active{background:var(--bg3)}
.doc-btn.del{color:var(--red);border-color:transparent}

.docs-pasta-block{ margin-bottom:6px; }
.docs-pasta-chevron{transition:transform .2s;display:inline-block;margin-left:auto;color:var(--t3);font-size:12px}
.docs-pasta-title{
  font-size:13px;font-weight:800;color:var(--t1);
  background:var(--card2);border:1px solid var(--border);
  border-radius:10px;padding:11px 14px;margin:10px 0 6px;
  display:flex;align-items:center;justify-content:space-between;
}
.docs-sub-title{
  font-size:11px;font-weight:700;color:var(--t2);
  padding:8px 14px 4px;
  display:flex;align-items:center;justify-content:space-between;
}
.docs-badge{
  background:var(--bg3);color:var(--t2);
  font-size:10px;font-weight:700;padding:1px 7px;border-radius:100px;
}
.docs-group-title{
  font-size:10px;font-weight:700;letter-spacing:1.5px;
  text-transform:uppercase;color:var(--t3);
  padding:14px 0 7px;display:flex;align-items:center;justify-content:space-between;
}
.docs-empty{
  text-align:center;padding:40px 16px;
}
.docs-empty .de-ico{font-size:40px;margin-bottom:12px}
.docs-empty .de-title{font-size:15px;font-weight:700;color:var(--t2);margin-bottom:6px}
.docs-empty .de-sub{font-size:12px;color:var(--t3);line-height:1.6}

.task-comprov-link{
  display:inline-flex;align-items:center;gap:4px;
  font-size:11px;font-weight:700;color:var(--green);
  text-decoration:none;padding:3px 8px;
  background:var(--green2);border-radius:6px;
}
/* loader */
#loader{
  position:fixed;inset:0;background:rgba(15,25,35,.8);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:500;opacity:0;pointer-events:none;transition:opacity .2s;
}
#loader.show{opacity:1;pointer-events:all}
.sp{width:34px;height:34px;border:3px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:10px}
#loader p{font-size:13px;color:var(--t2)}
</style>
</head>
<body>

<div id="app">

<!-- â•â• SETUP â•â• -->
<div id="setup">
  <div class="ico">âš¡</div>
  <h2>Configurar o App</h2>
  <p>Cole a URL do seu Google Apps Script.<br>VocÃª sÃ³ precisa fazer isso uma vez.</p>
  <input id="su-url" type="url" placeholder="https://script.google.com/macros/s/...">
  <button onclick="doSetup()">Salvar e ComeÃ§ar â†’</button>
  <div class="note">
    <b>Como obter a URL:</b><br>
    1. Acesse script.google.com â†’ Novo projeto<br>
    2. Cole o cÃ³digo do arquivo Code.gs<br>
    3. Implantar â†’ Nova implantaÃ§Ã£o â†’ App da Web<br>
    4. Acesso: <b>Qualquer pessoa</b> â†’ Implantar<br>
    5. Copie a URL e cole acima
  </div>
</div>

<!-- â•â• LOADER â•â• -->
<div id="loader"><div class="sp"></div><p id="loader-msg">Carregando...</p></div>

<!-- â•â• HEADER â•â• -->
<div id="hdr" style="display:none">
  <div id="hdr-top">
    <div class="logo" onclick="if(confirm('Trocar URL do servidor?'))resetSetup();" style="cursor:pointer">âš¡ Fluxo</div>
    <div class="right">
      <span id="offline-badge">â— offline</span>
      <button id="sync-btn" onclick="syncAll()">â†» Sync</button>
    </div>
  </div>

  <!-- balance + fin tabs: sÃ³ aparece na aba FinanÃ§as -->
  <div id="fin-header-extra" style="display:none">
    <div id="bal" style="margin-bottom:12px">
      <div class="lbl">Saldo do MÃªs â€” <span id="month-chip">â€”</span></div>
      <div id="bal-val">R$ 0,00</div>
      <div id="bal-row">
        <div class="bal-cell"><div class="bl inc">â†‘ Receitas</div><div class="bv" id="bi">R$ 0,00</div></div>
        <div class="bal-cell"><div class="bl exp">â†“ Despesas</div><div class="bv" id="be">R$ 0,00</div></div>
      </div>
    </div>
    <div id="fin-tabs">
      <button class="ftab on" onclick="ftab('add')">â• Registrar</button>
      <button class="ftab" onclick="ftab('hist')">ğŸ“‹ HistÃ³rico</button>
      <button class="ftab" onclick="ftab('cat')">ğŸ“Š Resumo</button>
      <button class="ftab" onclick="ftab('agenda')">ğŸ“… Agenda</button>
    </div>
  </div>
</div>

<!-- â•â• CONTENT â•â• -->
<div id="content" style="display:none">

  <!-- â”€â”€ FINANCE â”€â”€ -->
  <div id="sec-fin">

    <!-- ADD -->
    <div class="pg on" id="fp-add">
      <div class="card" style="margin-top:12px">
        <div class="card-title">âš¡ Registro rÃ¡pido</div>
        <div class="type-row">
          <button class="ttype exp" id="bt-exp" onclick="setTxType('exp')">ğŸ”´ Despesa</button>
          <button class="ttype" id="bt-inc" onclick="setTxType('inc')">ğŸŸ¢ Receita</button>
        </div>
        <div class="row2">
          <div><div class="fl">DescriÃ§Ã£o</div><input id="tx-desc" type="text" placeholder="Ex: Mercado..." maxlength="50"></div>
          <div><div class="fl">Valor</div><div class="r-wrap"><input id="tx-val" type="number" placeholder="0,00" step="0.01" min="0" inputmode="decimal"></div></div>
        </div>
        <div class="row2">
          <div>
            <div class="fl">Categoria</div>
            <select id="tx-cat">
              <optgroup label="â”€â”€ Gastos â”€â”€">
                <option>ğŸ½ï¸ AlimentaÃ§Ã£o</option>
                <option>ğŸš— Carro/Transporte</option>
                <option>ğŸ  Casa/Moradia</option>
                <option>ğŸ’Š SaÃºde</option>
                <option>ğŸ“š EducaÃ§Ã£o</option>
                <option>ğŸ‘— Roupas</option>
                <option>ğŸ® Lazer</option>
                <option>ğŸ’¼ Empresa/NegÃ³cio</option>
                <option>ğŸ›ï¸ Taxas/Impostos</option>
                <option>ğŸ’³ CartÃ£o de CrÃ©dito</option>
                <option>ğŸ“ˆ Investimentos</option>
                <option>ğŸ¦ Financiamentos</option>
                <option>ğŸ“¦ Outros</option>
              </optgroup>
              <optgroup label="â”€â”€ Receitas â”€â”€">
                <option>ğŸ’° SalÃ¡rio</option>
                <option>â­ Extra</option>
              </optgroup>
            </select>
          </div>
          <div><div class="fl">Data</div><input id="tx-date" type="date"></div>
        </div>
        <button class="btn" id="btn-add-tx" onclick="addTx()">Registrar âœ“</button>

        <!-- Comprovante -->
        <button class="comprov-btn" onclick="toggleComprov()">
          ğŸ“ <span>Anexar comprovante</span>
          <span style="margin-left:auto;font-size:11px;color:var(--t3)" id="comprov-badge"></span>
        </button>
        <div class="comprov-picker" id="comprov-picker">
          <input type="file" id="comprov-file" accept="image/*,application/pdf" capture="environment">
          <div class="comprov-file-area" onclick="document.getElementById('comprov-file').click()">
            <div class="comprov-file-icon">ğŸ“·</div>
            <div class="comprov-file-lbl">Foto, imagem ou PDF</div>
            <div class="comprov-file-sub">Toque para escolher ou tirar foto</div>
          </div>
          <div class="comprov-preview" id="comprov-preview">
            <div style="font-size:24px" id="comprov-ico">ğŸ“„</div>
            <div class="comprov-preview-info">
              <div class="comprov-preview-name" id="comprov-fname"></div>
              <div class="comprov-preview-size" id="comprov-fsize"></div>
            </div>
            <button class="comprov-upload-btn" onclick="uploadComprov()">Enviar â†‘</button>
          </div>
          <div class="comprov-progress" id="comprov-progress">
            <div class="comprov-progress-bar" id="comprov-bar"></div>
          </div>
          <div class="comprov-link" id="comprov-link">
            <span style="font-size:16px">âœ…</span>
            <span class="comprov-link-url" id="comprov-link-url"></span>
            <button class="comprov-link-copy" onclick="copyComprovLink()">Copiar link</button>
          </div>
        </div>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="pg" id="fp-hist">
      <div class="mfrow" id="mf-row"></div>
      <div class="slbl">LanÃ§amentos</div>
      <div class="txl" id="tx-list"></div>
    </div>

    <!-- CATEGORIES -->
    <div class="pg" id="fp-cat">
      <div class="slbl">Despesas por Categoria â€” <span id="cat-month-lbl"></span></div>
      <div class="catl" id="cat-list"></div>
    </div>

    <!-- AGENDA -->
    <div class="pg" id="fp-agenda">
      <div class="vtog" style="margin-top:12px">
        <button class="vbtn on" id="fv-day"    onclick="setFinView('day')">ğŸ“… Dia</button>
        <button class="vbtn"    id="fv-week"   onclick="setFinView('week')">ğŸ—“ Sem</button>
        <button class="vbtn"    id="fv-month"  onclick="setFinView('month')">ğŸ“† MÃªs</button>
        <button class="vbtn"    id="fv-future" onclick="setFinView('future')">ğŸ”® Plan</button>
      </div>

      <div id="fvw-day">
        <div class="day-nav">
          <button class="dnav-btn" onclick="shiftFD(-1)">â€¹</button>
          <div class="dnav-lbl"><div class="dnav-date" id="fd-date"></div><div class="dnav-sub" id="fd-sub"></div></div>
          <button class="dnav-btn" onclick="shiftFD(1)">â€º</button>
        </div>
        <div class="balmini" id="fd-bal"></div>
        <div class="txl" id="fd-list"></div>
      </div>

      <div id="fvw-week" style="display:none">
        <div class="wnav">
          <button class="wnav-btn" onclick="shiftFW(-1)">â€¹ Ant</button>
          <div class="wnav-lbl" id="fw-lbl"></div>
          <button class="wnav-btn" onclick="shiftFW(1)">PrÃ³x â€º</button>
        </div>
        <div class="wstrip" id="fw-strip"></div>
        <div class="balmini" id="fw-bal"></div>
        <div class="txl" id="fw-list"></div>
      </div>

      <div id="fvw-month" style="display:none">
        <div class="mnav">
          <button class="mnav-btn" onclick="shiftFM(-1)">â€¹</button>
          <div class="mnav-lbl" id="fm-lbl"></div>
          <button class="mnav-btn" onclick="shiftFM(1)">â€º</button>
        </div>
        <div class="mgrid" id="fm-grid"></div>
        <div class="balmini" id="fm-bal"></div>
        <div class="txl" id="fm-list"></div>
      </div>

      <div id="fvw-future" style="display:none">
        <div class="slbl" style="padding-top:8px">ğŸ”® PrÃ³ximos 3 meses</div>
        <div id="future-body"></div>
      </div>
    </div>

  </div><!-- /sec-fin -->

  <!-- â”€â”€ TASKS â”€â”€ -->
  <div id="sec-task" style="display:none">

    <!-- form -->
    <div class="card" style="margin-top:12px">
      <div class="coll-hdr card-title" onclick="toggleTF()">
        <span>ğŸ“Œ Novo Compromisso</span>
        <span class="coll-arrow" id="tf-arrow">â–¾</span>
      </div>
      <div class="coll-body" id="tf-body">
        <div style="margin-bottom:8px"><div class="fl">DescriÃ§Ã£o</div><input id="t-desc" type="text" placeholder="Ex: Pagar aluguel, Dentista..." maxlength="80"></div>
        <div class="row2">
          <div><div class="fl">Tipo</div><select id="t-type" onchange="onTaskTypeChange()"><option value="exp">ğŸ”´ Despesa</option><option value="inc">ğŸŸ¢ Receita</option><option value="task">ğŸ“Œ Compromisso</option></select></div>
          <div><div class="fl">Data / Prazo</div><input id="t-dead" type="date"></div>
        </div>
        <div class="row2" id="t-val-row">
          <div><div class="fl">Valor</div><div class="r-wrap"><input id="t-val" type="number" placeholder="0,00" step="0.01" min="0" inputmode="decimal"></div></div>
          <div id="t-cat-wrap"><div class="fl">Categoria</div>
            <select id="t-cat">
              <optgroup label="â”€â”€ Despesas â”€â”€">
                <option>ğŸ½ï¸ AlimentaÃ§Ã£o</option>
                <option>ğŸš— Carro/Transporte</option>
                <option>ğŸ  Casa/Moradia</option>
                <option>ğŸ’Š SaÃºde</option>
                <option>ğŸ“š EducaÃ§Ã£o</option>
                <option>ğŸ‘— Roupas</option>
                <option>ğŸ® Lazer</option>
                <option>ğŸ’¼ Empresa/NegÃ³cio</option>
                <option>ğŸ›ï¸ Taxas/Impostos</option>
                <option>ğŸ’³ CartÃ£o de CrÃ©dito</option>
                <option>ğŸ“ˆ Investimentos</option>
                <option>ğŸ¦ Financiamentos</option>
                <option>ğŸ“¦ Outros</option>
              </optgroup>
              <optgroup label="â”€â”€ Receitas â”€â”€">
                <option>ğŸ’° SalÃ¡rio</option>
                <option>â­ Extra</option>
              </optgroup>
            </select>
          </div>
        </div>
        <div id="t-task-note" style="display:none;font-size:12px;color:var(--t3);margin-bottom:8px;padding:8px 10px;background:var(--bg3);border-radius:8px">ğŸ“Œ Compromisso sem valor financeiro â€” nÃ£o impacta o balanÃ§o.</div>
        <div class="recur-toggle" id="recur-toggle" onclick="toggleRecur()">
          <div class="recur-toggle-dot" id="recur-dot"></div>
          <div class="recur-toggle-lbl">Repetir todo mÃªs</div>
          <span class="recur-badge" id="recur-badge">inativo</span>
        </div>
        <button class="btn" id="btn-add-task" onclick="addTask()">Adicionar âœ“</button>
      </div>
    </div>

    <!-- view toggle -->
    <div class="vtog" style="grid-template-columns:repeat(5,1fr)">
      <button class="vbtn on" id="tv-list"  onclick="setTaskView('list')">ğŸ“‹ Lista</button>
      <button class="vbtn"    id="tv-day"   onclick="setTaskView('day')">ğŸ“… Dia</button>
      <button class="vbtn"    id="tv-week"  onclick="setTaskView('week')">ğŸ—“ Sem</button>
      <button class="vbtn"    id="tv-month" onclick="setTaskView('month')">ğŸ“† MÃªs</button>
      <button class="vbtn"    id="tv-plan"  onclick="setTaskView('plan')">ğŸ”® Plan</button>
    </div>

    <!-- LIST -->
    <div id="tvw-list">
      <div id="task-open"></div>
      <div class="slbl">ConcluÃ­das</div>
      <div id="task-done"></div>
    </div>

    <!-- DAY -->
    <div id="tvw-day" style="display:none">
      <div class="day-nav">
        <button class="dnav-btn" onclick="shiftTD(-1)">â€¹</button>
        <div class="dnav-lbl"><div class="dnav-date" id="td-date"></div><div class="dnav-sub" id="td-sub"></div></div>
        <button class="dnav-btn" onclick="shiftTD(1)">â€º</button>
      </div>
      <div id="td-list"></div>
    </div>

    <!-- WEEK -->
    <div id="tvw-week" style="display:none">
      <div class="wnav">
        <button class="wnav-btn" onclick="shiftTW(-1)">â€¹ Ant</button>
        <div class="wnav-lbl" id="tw-lbl"></div>
        <button class="wnav-btn" onclick="shiftTW(1)">PrÃ³x â€º</button>
      </div>
      <div class="wstrip" id="tw-strip"></div>
      <div id="tw-list"></div>
    </div>

    <!-- MONTH -->
    <div id="tvw-month" style="display:none">
      <div class="mnav">
        <button class="mnav-btn" onclick="shiftTM(-1)">â€¹</button>
        <div class="mnav-lbl" id="tm-lbl"></div>
        <button class="mnav-btn" onclick="shiftTM(1)">â€º</button>
      </div>
      <div class="mgrid" id="tm-grid"></div>
      <div id="tm-list"></div>
    </div>

    <!-- PLAN -->
    <div id="tvw-plan" style="display:none">
      <div class="slbl" style="padding-top:8px">ğŸ”® PrÃ³ximos 90 dias</div>
      <div id="tp-body"></div>
    </div>

  </div><!-- /sec-task -->

  <!-- â•â• HOJE â•â• -->
  <div id="sec-hoje" style="display:none">

    <!-- cabeÃ§alho com data e contadores -->
    <div class="hoje-header">
      <div class="hoje-greeting">â˜€ï¸ Bom dia! Seu resumo de hoje</div>
      <div class="hoje-date" id="hoje-date-lbl">â€”</div>
      <div class="hoje-counters">
        <div class="hoje-counter">
          <div class="hc-num alert" id="hc-pgto">0</div>
          <div class="hc-lbl" style="color:#FF6B6B">Pagamentos</div>
        </div>
        <div class="hoje-counter">
          <div class="hc-num warn" id="hc-task">0</div>
          <div class="hc-lbl" style="color:#FFD166">Compromissos</div>
        </div>
        <div class="hoje-counter">
          <div class="hc-num ok" id="hc-rec">0</div>
          <div class="hc-lbl" style="color:#2ECC9A">Recebimentos</div>
        </div>
      </div>
    </div>

    <!-- gastos do dia -->
    <div class="hoje-section" id="hs-pgto">
      <div class="hoje-section-title">
        ğŸ’¸ Pagamentos de hoje
        <span class="hst-badge" id="hb-pgto">0</span>
      </div>
      <div id="hoje-pgto-list"></div>
    </div>

    <!-- recebimentos do dia -->
    <div class="hoje-section" id="hs-rec">
      <div class="hoje-section-title">
        ğŸ’° Recebimentos de hoje
        <span class="hst-badge" id="hb-rec">0</span>
      </div>
      <div id="hoje-rec-list"></div>
    </div>

    <!-- tarefas do dia -->
    <div class="hoje-section" id="hs-task">
      <div class="hoje-section-title">
        ğŸ“… Compromissos de hoje
        <span class="hst-badge" id="hb-task">0</span>
      </div>
      <div id="hoje-task-list"></div>
    </div>

    <!-- atrasados -->
    <div class="hoje-section" id="hs-atrasado">
      <div class="hoje-section-title" style="color:#FF6B6B">
        âš ï¸ Atrasados (dias anteriores)
        <span class="hst-badge" id="hb-atrasado">0</span>
      </div>
      <div id="hoje-atrasado-list"></div>
    </div>

  </div><!-- /sec-hoje -->

  <!-- â•â• DOCS â•â• -->
  <div id="sec-docs" style="display:none">

    <!-- form adicionar link -->
    <div class="docs-add">
      <div class="coll-hdr card-title" onclick="toggleDocsForm()">
        <span>ğŸ”— Adicionar documento</span>
        <span class="coll-arrow" id="df-arrow">â–¾</span>
      </div>
      <div class="docs-form" id="df-body">

        <div><div class="fl">Nome do arquivo</div>
          <input id="d-name" type="text" placeholder="Ex: Contrato Social, RG JoÃ£o..." maxlength="80">
        </div>

        <div><div class="fl">Link (Google Drive, Docs, Sheets...)</div>
          <input id="d-url" type="url" placeholder="https://drive.google.com/...">
        </div>

        <div class="row2">
          <div><div class="fl">Tipo de arquivo</div>
            <select id="d-type">
              <option value="doc">ğŸ“„ Documento</option>
              <option value="sheet">ğŸ“Š Planilha</option>
              <option value="pdf">ğŸ“• PDF</option>
              <option value="img">ğŸ–¼ï¸ Imagem</option>
              <option value="slide">ğŸ“‘ ApresentaÃ§Ã£o</option>
              <option value="folder">ğŸ“ Pasta</option>
              <option value="link">ğŸ”— Link</option>
            </select>
          </div>
          <div><div class="fl">Pasta principal</div>
            <select id="d-pasta" onchange="onPastaChange()">
              <option value="Documentos Pessoais">ğŸ‘¤ Documentos Pessoais</option>
              <option value="Empresa">ğŸ¢ Empresa</option>
              <option value="ImÃ³veis e Loteamentos">ğŸ—ï¸ ImÃ³veis e Loteamentos</option>
              <option value="Financeiro">ğŸ’° Financeiro</option>
              <option value="Outros">ğŸ“¦ Outros</option>
            </select>
          </div>
        </div>

        <div><div class="fl">Subpasta <span style="color:var(--t3);font-weight:400">(opcional)</span></div>
          <input id="d-subpasta" type="text" placeholder="Ex: Empresa ABC, Loteamento XYZ, JoÃ£o Silva..." maxlength="50">
        </div>

        <button class="btn" id="btn-add-doc" onclick="addDoc()">Salvar Link âœ“</button>
      </div>
    </div>

    <!-- DEBUG â€” remover apÃ³s resolver -->
    <!-- lista de documentos -->
    <div id="docs-list"></div>

  </div><!-- /sec-docs -->

</div><!-- /content -->

<!-- â•â• MODAL COMPROVANTE TAREFA â•â• -->
<div id="comprov-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:999;padding:20px;display:none;align-items:flex-end;justify-content:center">
  <div style="background:var(--card);border-radius:18px 18px 0 0;width:100%;max-width:480px;padding:20px;margin:0 auto">
    <div style="font-size:15px;font-weight:800;color:var(--t1);margin-bottom:4px">âœ… Marcar como concluÃ­da</div>
    <div style="font-size:12px;color:var(--t3);margin-bottom:16px">Deseja anexar o comprovante de pagamento?</div>

    <input type="file" id="task-comprov-file" accept="image/*,application/pdf" capture="environment" style="display:none">
    <div id="task-comprov-area" style="border:2px dashed var(--border);border-radius:10px;padding:18px;text-align:center;cursor:pointer;margin-bottom:12px" onclick="document.getElementById('task-comprov-file').click()">
      <div style="font-size:28px;margin-bottom:6px">ğŸ“</div>
      <div style="font-size:13px;font-weight:600;color:var(--t2)">Foto ou PDF do comprovante</div>
      <div style="font-size:11px;color:var(--t3);margin-top:3px">opcional â€” pode pular</div>
    </div>
    <div id="task-comprov-preview" style="display:none;background:var(--bg3);border-radius:8px;padding:10px 12px;margin-bottom:12px;font-size:12px;color:var(--t2)"></div>
    <div id="task-comprov-progress" style="display:none;background:var(--bg3);border-radius:100px;height:4px;margin-bottom:12px;overflow:hidden">
      <div id="task-comprov-bar" style="height:100%;background:var(--green);width:0%;transition:width .3s"></div>
    </div>

    <div style="display:flex;gap:10px">
      <button onclick="closeComprovModal()" style="flex:1;padding:12px;border-radius:10px;border:1px solid var(--border);background:none;color:var(--t2);font-size:13px;font-weight:600;cursor:pointer;font-family:inherit">Pular</button>
      <button id="task-comprov-send" onclick="sendTaskComprov()" style="flex:2;padding:12px;border-radius:10px;border:none;background:var(--green);color:#0A1A12;font-size:13px;font-weight:800;cursor:pointer;font-family:inherit">Concluir âœ“</button>
    </div>
  </div>
</div>

<!-- â•â• MODAL RECORRÃŠNCIA â•â• -->
<div id="recur-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:1000;align-items:flex-end;justify-content:center;padding:0">
  <div style="background:var(--card);border-radius:18px 18px 0 0;width:100%;max-width:480px;padding:22px 20px 32px;margin:0 auto">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px">
      <span style="font-size:20px">ğŸ”</span>
      <div>
        <div style="font-size:15px;font-weight:800;color:var(--t1)" id="rm-title">RecorrÃªncia mensal</div>
        <div style="font-size:11px;color:var(--t3)" id="rm-sub">Todo mÃªs na mesma data</div>
      </div>
    </div>
    <div style="margin-bottom:14px">
      <div class="fl">Valor dos prÃ³ximos meses</div>
      <div class="r-wrap"><input id="rm-val" type="number" step="0.01" min="0" inputmode="decimal" placeholder="0,00" style="font-size:18px;font-weight:800"></div>
    </div>
    <div style="margin-bottom:18px">
      <div class="fl">Categoria</div>
      <select id="rm-cat">
        <optgroup label="â”€â”€ Despesas â”€â”€">
          <option>ğŸ½ï¸ AlimentaÃ§Ã£o</option><option>ğŸš— Carro/Transporte</option>
          <option>ğŸ  Casa/Moradia</option><option>ğŸ’Š SaÃºde</option>
          <option>ğŸ“š EducaÃ§Ã£o</option><option>ğŸ‘— Roupas</option>
          <option>ğŸ® Lazer</option><option>ğŸ’¼ Empresa/NegÃ³cio</option>
          <option>ğŸ›ï¸ Taxas/Impostos</option>
          <option>ğŸ’³ CartÃ£o de CrÃ©dito</option>
          <option>ğŸ“ˆ Investimentos</option>
          <option>ğŸ¦ Financiamentos</option>
          <option>ğŸ“¦ Outros</option>
        </optgroup>
        <optgroup label="â”€â”€ Receitas â”€â”€">
          <option>ğŸ’° SalÃ¡rio</option><option>â­ Extra</option>
        </optgroup>
      </select>
    </div>
    <button onclick="saveRecurEdit()" style="width:100%;padding:13px;border-radius:10px;border:none;background:var(--green);color:#0A1A12;font-size:14px;font-weight:800;cursor:pointer;font-family:inherit;margin-bottom:10px">Salvar alteraÃ§Ãµes âœ“</button>
    <button onclick="cancelRecurFromModal()" style="width:100%;padding:12px;border-radius:10px;border:1px solid var(--red);background:none;color:var(--red);font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;margin-bottom:10px">ğŸ—‘ï¸ Cancelar recorrÃªncia</button>
    <button onclick="closeRecurModal()" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:none;color:var(--t3);font-size:12px;cursor:pointer;font-family:inherit">Fechar</button>
  </div>
</div>

<!-- â•â• BOTTOM NAV â•â• -->
<div id="nav" style="display:none">
  <button class="nb on" id="nb-hoje" onclick="setSection('hoje')"><span class="ni">â˜€ï¸</span>Hoje</button>
  <button class="nb"    id="nb-fin"  onclick="setSection('fin')"><span class="ni">ğŸ’³</span>FinanÃ§as</button>
  <button class="nb"    id="nb-task" onclick="setSection('task')"><span class="ni">ğŸ“…</span>Compromissos</button>
  <button class="nb"    id="nb-docs" onclick="setSection('docs')"><span class="ni">ğŸ“</span>Docs</button>
</div>

<!-- â•â• TOAST â•â• -->
<div id="toast"></div>

</div><!-- /app -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var API = ''; // will be loaded in init() after DOM ready
var TXS   = JSON.parse(localStorage.getItem('ff_txs')   || '[]');
var TASKS = JSON.parse(localStorage.getItem('ff_tasks') || '[]');
var RECUR = JSON.parse(localStorage.getItem('ff_recur') || '[]');
var COLLAPSED_PASTAS = JSON.parse(localStorage.getItem('ff_collapsed') || '[]');
var curRecur = false; // toggle do form

var curSection  = 'fin';
var curFinTab   = 'add';
var curFinView  = 'day';
var curTaskView = 'list';
var curTxType   = 'exp';
var selMonth    = '';
var tfOpen      = true;
var online      = navigator.onLine;

// calendar state
var fdDate  = today0(); // fin day
var fwStart = weekStart(new Date()); // fin week
var fmDate  = new Date(); // fin month
var tdDate  = today0(); // task day
var twStart = weekStart(new Date()); // task week
var tmDate  = new Date(); // task month

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function today0(){ var d=new Date(); d.setHours(0,0,0,0); return d; }
function ymd(d){ return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
function ymds(s){
  // Normaliza qualquer formato de data para YYYY-MM-DD
  if(!s) return '';
  var str = String(s).trim();
  // ISO com T: "2026-02-15T03:00:00.000Z" â†’ pega sÃ³ a parte da data
  if(str.indexOf('T') !== -1) str = str.split('T')[0];
  // JÃ¡ Ã© YYYY-MM-DD (com possÃ­veis zeros faltando)
  if(/^\d{4}-\d{1,2}-\d{1,2}$/.test(str)){
    var p=str.split('-');
    return p[0]+'-'+pad(parseInt(p[1]))+'-'+pad(parseInt(p[2]));
  }
  // Formato DD/MM/YYYY
  if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(str)){
    var p=str.split('/');
    return p[2]+'-'+pad(parseInt(p[1]))+'-'+pad(parseInt(p[0]));
  }
  // Tenta converter como Date (Ãºltimo recurso)
  try{
    var d=new Date(str);
    if(!isNaN(d.getTime())) return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate());
  }catch(e){}
  return str;
}
function pad(n){ return String(n).padStart(2,'0'); }
function weekStart(d){
  var dt=new Date(d); var day=dt.getDay();
  var diff = day===0 ? -6 : 1-day;
  dt.setDate(dt.getDate()+diff); dt.setHours(0,0,0,0); return dt;
}
function fmtBRL(v){
  return Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
}
function fmtDate(s){
  if(!s) return '';
  var p=String(s).trim().split('-');
  if(p.length!==3) return String(s);
  return pad(parseInt(p[2]))+'/'+pad(parseInt(p[1]))+'/'+p[0];
}
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function toast(msg,type){
  var t=document.getElementById('toast');
  t.textContent=msg; t.className='toast '+(type||'ok')+' show';
  setTimeout(function(){ t.classList.remove('show'); },2600);
}
function load(show,msg){
  document.getElementById('loader').classList.toggle('show',show);
  if(msg) document.getElementById('loader-msg').textContent=msg;
}
function save(){
  localStorage.setItem('ff_txs',   JSON.stringify(TXS));
  localStorage.setItem('ff_tasks', JSON.stringify(TASKS));
}
function balOf(list){
  var i=0,e=0;
  list.forEach(function(t){
    if(t.type!=='inc' && t.type!=='exp') return; // ignorar invÃ¡lidos
    var v=parseFloat(t.value||0);
    if(isNaN(v)||v<=0) return; // ignorar zeros/NaN
    if(t.type==='inc') i+=v; else e+=v;
  });
  return {i:i,e:e,b:i-e};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doSetup(){
  var u=document.getElementById('su-url').value.trim();
  if(!u){toast('âš ï¸ Cole a URL do Apps Script','err');return;}
  // Accept any URL - user might paste without https in some cases
  if(u.indexOf('script.google.com')===-1 && u.indexOf('http')===-1){
    toast('âš ï¸ URL invÃ¡lida â€” verifique','err');return;
  }
  API=u;
  try{ localStorage.setItem('ff_api',u); }catch(e){}
  document.getElementById('setup').style.display='none';
  boot();
}

function resetSetup(){
  try{ localStorage.removeItem('ff_api'); }catch(e){}
  API='';
  document.getElementById('setup').style.display='flex';
  document.getElementById('hdr').style.display='none';
  document.getElementById('content').style.display='none';
  document.getElementById('nav').style.display='none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function boot(){
  var now=new Date();
  selMonth=now.getFullYear()+'-'+pad(now.getMonth()+1);

  document.getElementById('month-chip').textContent=
    now.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  document.getElementById('cat-month-lbl').textContent=
    now.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});

  document.getElementById('tx-date').value = ymd(now);
  document.getElementById('t-dead').value  = ymd(now);

  document.getElementById('hdr').style.display='block';
  document.getElementById('content').style.display='block';
  document.getElementById('nav').style.display='flex';

  // DelegaÃ§Ã£o global de eventos das tarefas (feito uma vez)
  initTaskDelegation();
  // Abre na tela Hoje por padrÃ£o
  setSection('hoje');
  renderAll();
  syncAll();
}

window.addEventListener('online',  function(){ online=true;  document.getElementById('offline-badge').style.display='none'; });
window.addEventListener('offline', function(){ online=false; document.getElementById('offline-badge').style.display='inline'; });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function apiCall(action, body, cb){
  var url = API + '?action=' + action;
  if(body){
    url += '&payload=' + encodeURIComponent(JSON.stringify(body));
  }
  fetch(url, { method:'GET', redirect:'follow', headers:{'Accept':'application/json, text/plain, */*'} })
  .then(function(r){ return r.text(); })
  .then(function(txt){
    if(txt.indexOf('<html')!==-1||txt.indexOf('<!DOCTYPE')!==-1)
      throw new Error('Servidor retornou HTML â€” verifique publicaÃ§Ã£o do Apps Script');
    try{ cb(null, JSON.parse(txt)); }
    catch(e){ cb(new Error('JSON invÃ¡lido: '+txt.substring(0,120))); }
  })
  .catch(function(e){
    var xhr=new XMLHttpRequest();
    xhr.open('GET',url,true);
    xhr.setRequestHeader('Accept','application/json, text/plain, */*');
    xhr.onload=function(){
      try{ cb(null,JSON.parse(xhr.responseText)); }
      catch(ex){ cb(new Error('XHR JSON invÃ¡lido: '+xhr.responseText.substring(0,120))); }
    };
    xhr.onerror=function(){ cb(new Error('Sem conexÃ£o ou URL incorreta')); };
    xhr.send();
  });
}

// Para uploads (base64) â€” usa POST para evitar limite de URL
function apiPost(action, body, cb){
  var url = API + '?action=' + action;
  fetch(url, {
    method: 'POST',
    redirect: 'follow',
    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json, text/plain, */*' },
    body: JSON.stringify(body)
  })
  .then(function(r){ return r.text(); })
  .then(function(txt){
    if(txt.indexOf('<html')!==-1||txt.indexOf('<!DOCTYPE')!==-1)
      throw new Error('Servidor retornou HTML â€” verifique publicaÃ§Ã£o do Apps Script');
    try{ cb(null, JSON.parse(txt)); }
    catch(e){ cb(new Error('JSON invÃ¡lido: '+txt.substring(0,120))); }
  })
  .catch(function(e){
    // Fallback XHR POST
    var xhr=new XMLHttpRequest();
    xhr.open('POST',url,true);
    xhr.setRequestHeader('Content-Type','application/json');
    xhr.setRequestHeader('Accept','application/json, text/plain, */*');
    xhr.onload=function(){
      try{ cb(null,JSON.parse(xhr.responseText)); }
      catch(ex){ cb(new Error('XHR JSON invÃ¡lido: '+xhr.responseText.substring(0,120))); }
    };
    xhr.onerror=function(){ cb(new Error('Erro de rede no upload')); };
    xhr.send(JSON.stringify(body));
  });
}

function syncAll(){
  if(!online){ toast('ğŸ“µ Offline â€” usando cache','err'); return; }
  var btn=document.getElementById('sync-btn');
  btn.classList.add('spinning'); load(true,'Sincronizando...');
  var done=0;
  var recurReady=false, tasksReady=false;

  function tryProcessRecur(){
    // SÃ³ rodar processRecur depois que RECUR e TASKS estiverem atualizados
    if(recurReady && tasksReady) processRecur();
  }

  function tick(){
    done++;
    if(done===4){ btn.classList.remove('spinning'); load(false); renderAll(); toast('âœ… Sincronizado!'); }
  }

  apiCall('getRecur',null,function(err,d){
    if(!err && d && d.ok && d.data){
      var serverIds = d.data.map(function(r){ return String(r.id); });
      var localOnly = RECUR.filter(function(r){ return serverIds.indexOf(String(r.id))===-1; });
      RECUR = d.data.concat(localOnly);
      saveRecur();
    }
    recurReady = true;
    tryProcessRecur();
    tick();
  });

  apiCall('getDocs',null,function(err,d){
    if(!err && d.ok){
      DOCS = d.data.map(function(x){
        return {
          id:       String(x.id      || Date.now()),
          name:     String(x.name    || ''),
          url:      String(x.url     || ''),
          type:     String(x.type    || 'doc'),
          pasta:    String(x.pasta   || x.group || 'Outros'),
          subpasta: String(x.subpasta|| '')
        };
      });
      localStorage.setItem('ff_docs', JSON.stringify(DOCS));
    }
    tick();
  });

  apiCall('getTransactions',null,function(err,d){
    if(!err && d.ok){
      TXS = d.data
        .map(function(t){
          return Object.assign({}, t, {
            date:  ymds(t.date),
            desc:  String(t.desc  || t.description || ''),
            value: parseFloat(t.value || t.amount || t.valor || 0),
            cat:   String(t.cat   || t.category   || t.categoria || 'ğŸ“¦ Outros'),
            type:  String(t.type  || t.tipo || ''),
            id:    String(t.id    || t.ID  || Date.now())
          });
        })
        .filter(function(t){
          // Descartar qualquer linha com type invÃ¡lido
          // (lixo gerado pela versÃ£o antiga do processRecur)
          return t.type === 'inc' || t.type === 'exp';
        });
      save();
    }
    tick();
  });

  apiCall('getTasks',null,function(err,d){
    if(!err && d.ok){
      TASKS = d.data.map(function(t){
        return Object.assign({}, t, {
          deadline:  ymds(t.deadline || t.prazo || t.due || ''),
          desc:      String(t.desc || t.description || t.descricao || ''),
          status:    String(t.status || 'pend'),
          type:      String(t.type   || t.tipo || 'exp'),
          id:        String(t.id     || t.ID   || Date.now()),
          recurId:   t.recurId ? String(t.recurId) : ''
        });
      });
      save();
    }
    tasksReady = true;
    tryProcessRecur();
    tick();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSection(s){
  curSection=s;
  document.getElementById('sec-fin').style.display        = s==='fin'  ? 'block':'none';
  document.getElementById('sec-task').style.display       = s==='task' ? 'block':'none';
  document.getElementById('sec-hoje').style.display       = s==='hoje' ? 'block':'none';
  document.getElementById('sec-docs').style.display       = s==='docs' ? 'block':'none';
  document.getElementById('fin-header-extra').style.display = s==='fin' ? 'block':'none';
  document.getElementById('nb-fin').classList.toggle('on',  s==='fin');
  document.getElementById('nb-task').classList.toggle('on', s==='task');
  document.getElementById('nb-hoje').classList.toggle('on', s==='hoje');
  document.getElementById('nb-docs').classList.toggle('on', s==='docs');
  if(s==='task') renderTasks();
  if(s==='hoje') renderHoje();
  if(s==='docs'){
    renderDocs();
    // Sync silencioso ao abrir aba docs para garantir dados atualizados
    if(online) syncDocs();
  }
}

function ftab(t){
  curFinTab=t;
  ['add','hist','cat','agenda'].forEach(function(x){
    document.getElementById('fp-'+x).classList.toggle('on', x===t);
  });
  document.querySelectorAll('.ftab').forEach(function(b,i){
    b.classList.toggle('on', ['add','hist','cat','agenda'][i]===t);
  });
  if(t==='hist')   renderHist();
  if(t==='cat')    renderCat();
  if(t==='agenda') renderFinView();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  renderBal();
  if(curFinTab==='hist')   renderHist();
  if(curFinTab==='cat')    renderCat();
  if(curFinTab==='agenda') renderFinView();
  if(curSection==='task')  renderTasks();
  if(curSection==='hoje')  renderHoje();
  renderDocs();  // sempre atualiza, independente da aba visÃ­vel
  renderFixos(); // sempre atualiza lista inline de fixos
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRANSACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTxType(t){
  curTxType=t;
  document.getElementById('bt-exp').className='ttype'+(t==='exp'?' exp':'');
  document.getElementById('bt-inc').className='ttype'+(t==='inc'?' inc':'');
  document.getElementById('tx-cat').value = t==='inc' ? 'ğŸ’¼ SalÃ¡rio':'ğŸ½ï¸ AlimentaÃ§Ã£o';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RECORRÃŠNCIA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMPROVANTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var comprovOpen = false;
var comprovFile = null;
var comprovLink = '';

function toggleComprov(){
  comprovOpen = !comprovOpen;
  document.getElementById('comprov-picker').style.display = comprovOpen ? 'block' : 'none';
}

document.addEventListener('DOMContentLoaded', function(){
  var inp = document.getElementById('comprov-file');
  if(inp) inp.addEventListener('change', function(){
    comprovFile = inp.files[0];
    if(!comprovFile) return;
    var prev = document.getElementById('comprov-preview');
    prev.classList.add('show');
    document.getElementById('comprov-fname').textContent = comprovFile.name;
    document.getElementById('comprov-fsize').textContent = (comprovFile.size/1024).toFixed(1)+' KB';
    document.getElementById('comprov-ico').textContent =
      comprovFile.type.indexOf('pdf') !== -1 ? 'ğŸ“•' :
      comprovFile.type.indexOf('image') !== -1 ? 'ğŸ–¼ï¸' : 'ğŸ“„';
    // Limpar link anterior
    document.getElementById('comprov-link').classList.remove('show');
    document.getElementById('comprov-bar').style.width = '0%';
    comprovLink = '';
    document.getElementById('comprov-badge').textContent = '';
  });
});

// Prepara base64 comprimido (imagens reduzidas para caber na URL do GAS)
function prepareFileB64(file, cb){
  if(file.type.indexOf('image') === -1){
    // PDF â€” ler direto
    var r = new FileReader();
    r.onload = function(e){ cb(e.target.result.split(',')[1], file.type); };
    r.readAsDataURL(file);
    return;
  }
  // Imagem â€” redimensionar para max 1200px antes de enviar
  var img = new Image();
  var objUrl = URL.createObjectURL(file);
  img.onload = function(){
    var MAX = 800;
    var w = img.width, h = img.height;
    if(w > MAX){ h = Math.round(h * MAX / w); w = MAX; }
    if(h > MAX){ w = Math.round(w * MAX / h); h = MAX; }
    var canvas = document.createElement('canvas');
    canvas.width = w; canvas.height = h;
    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
    URL.revokeObjectURL(objUrl);
    var dataUrl = canvas.toDataURL('image/jpeg', 0.60);
    cb(dataUrl.split(',')[1], 'image/jpeg');
  };
  img.src = objUrl;
}

function uploadComprov(){
  if(!comprovFile){ toast('âš ï¸ Escolha um arquivo primeiro','err'); return; }

  var desc  = document.getElementById('tx-desc').value.trim() || 'Comprovante';
  var date  = document.getElementById('tx-date').value || ymd(new Date());
  var fname = date.replace(/-/g,'') + '_' + desc.replace(/[^a-zA-Z0-9Ã€-Ãº ]/g,'').substring(0,30).trim();

  var prog = document.getElementById('comprov-progress');
  var bar  = document.getElementById('comprov-bar');
  prog.classList.add('show');
  bar.style.width = '20%';

  prepareFileB64(comprovFile, function(b64, mime){
    bar.style.width = '50%';
    apiPost('uploadComprovante', {name:fname, mimeType:mime, data:b64}, function(err, d){
      if(err || !d || !d.ok){
        bar.style.width = '0%';
        prog.classList.remove('show');
        toast('âŒ Erro: ' + (err ? err.message : (d && d.error)||'desconhecido'), 'err');
        return;
      }
      bar.style.width = '100%';
      setTimeout(function(){ prog.classList.remove('show'); }, 600);

      comprovLink = d.url;
      document.getElementById('comprov-link-url').textContent = d.url;
      document.getElementById('comprov-link').classList.add('show');
      document.getElementById('comprov-badge').textContent = 'âœ… pronto';

      // Salvar nos Docs â€” aguardar ID real do servidor
      var docEntry = {
        name:     fname,
        url:      d.url,
        type:     mime.indexOf('pdf')!==-1 ? 'pdf' : 'img',
        pasta:    'Financeiro',
        subpasta: 'Comprovantes'
      };
      apiCall('addDoc', docEntry, function(e2, r2){
        if(e2 || !r2 || !r2.ok){
          toast('âœ… Comprovante no Drive, mas erro ao salvar nos Docs: '+(e2?e2.message:(r2&&r2.error)||''),'err');
        } else {
          var saved = Object.assign({id: r2.id}, docEntry);
          DOCS.unshift(saved);
          localStorage.setItem('ff_docs', JSON.stringify(DOCS));
          renderDocs();
          toast('âœ… Comprovante salvo no Drive e nos Docs!');
        }
      });
    });
  });
}

function copyComprovLink(){
  if(!comprovLink) return;
  navigator.clipboard && navigator.clipboard.writeText(comprovLink)
    .then(function(){ toast('ğŸ“‹ Link copiado!'); })
    .catch(function(){ toast('Link: '+comprovLink.substring(0,50)+'...'); });
}

function toggleRecur(){
  curRecur = !curRecur;
  var tog = document.getElementById('recur-toggle');
  var dot = document.getElementById('recur-dot');
  var badge = document.getElementById('recur-badge');
  tog.classList.toggle('on', curRecur);
  dot.textContent = curRecur ? 'âœ“' : '';
  badge.textContent = curRecur ? 'mensal' : 'inativo';
}

function saveRecur(){
  localStorage.setItem('ff_recur', JSON.stringify(RECUR));
}

function renderFixos(){
  // Lista removida â€” Ã­cone ğŸ” aparece direto no card da tarefa
  var el = document.getElementById('fixos-inline');
  if(el) el.style.display = 'none';
}

var recurModalId = null;

function openRecurModal(rid){
  var r = RECUR.find(function(x){ return String(x.id)===String(rid); });
  if(!r) return;
  recurModalId = String(rid);
  document.getElementById('rm-title').textContent = r.desc;
  document.getElementById('rm-sub').textContent   = 'Todo dia '+pad(new Date((r.date||'2000-01-01')+'T12:00:00').getDate())+' de cada mÃªs';
  document.getElementById('rm-val').value = r.value || '';
  var catEl = document.getElementById('rm-cat');
  catEl.value = r.cat || 'ğŸ“¦ Outros';
  var modal = document.getElementById('recur-modal');
  modal.style.display = 'flex';
}

function closeRecurModal(){
  document.getElementById('recur-modal').style.display = 'none';
  recurModalId = null;
}

function saveRecurEdit(){
  if(!recurModalId) return;
  var r = RECUR.find(function(x){ return String(x.id)===String(recurModalId); });
  if(!r){ closeRecurModal(); return; }
  var newVal = parseFloat(document.getElementById('rm-val').value)||0;
  var newCat = document.getElementById('rm-cat').value;
  r.value = newVal;
  r.cat   = newCat;
  saveRecur();
  apiCall('addRecur', r, function(){}); // upsert no servidor
  closeRecurModal();
  renderTasks();
  toast('âœ… RecorrÃªncia atualizada!');
}

function cancelRecurFromModal(){
  if(!recurModalId) return;
  if(!confirm('Cancelar esta recorrÃªncia? Os lanÃ§amentos jÃ¡ gerados permanecem.')) return;
  delRecur(recurModalId);
  closeRecurModal();
}

function delRecur(id){
  RECUR = RECUR.filter(function(r){ return String(r.id) !== String(id); });
  saveRecur();
  apiCall('deleteRecur', {id:id}, function(){});
  renderTasks();
  toast('ğŸ—‘ï¸ RecorrÃªncia cancelada');
}

// Chamado no syncAll â€” cria lanÃ§amento deste mÃªs se ainda nÃ£o existe
function processRecur(){
  if(!RECUR.length) return;
  var now    = new Date();
  var today  = ymd(now); // YYYY-MM-DD
  var created = 0;

  // Gerar para os prÃ³ximos 3 meses a partir do mÃªs atual
  for(var mo = 0; mo < 3; mo++){
    var d = new Date(now.getFullYear(), now.getMonth() + mo, 1);
    var moStr = d.getFullYear()+'-'+pad(d.getMonth()+1);

    RECUR.forEach(function(r){
      var origDay    = new Date((r.date||today)+'T12:00:00').getDate();
      var targetDate = moStr+'-'+pad(origDay);

      // SÃ³ criar se a data alvo for >= hoje (nÃ£o gerar datas passadas)
      if(targetDate < today) return;

      // Checar por recurId OU por desc (fallback) no mesmo mÃªs
      var existsTask = TASKS.some(function(t){
        var tMo = ymds(t.deadline||'').substring(0,7);
        if(tMo !== moStr) return false;
        return (t.recurId && String(t.recurId) === String(r.id)) ||
               (t.desc === r.desc);
      });
      var existsTx = TXS.some(function(t){
        var tMo = ymds(t.date).substring(0,7);
        if(tMo !== moStr) return false;
        return (t.recurId && String(t.recurId) === String(r.id)) ||
               (t.desc === r.desc && (t.type === r.type));
      });

      if(!existsTask && !existsTx){
        var task = {
          desc:     r.desc,
          type:     r.type || 'exp',
          deadline: targetDate,
          value:    r.value,
          cat:      r.cat || '',
          status:   'pend',
          recurId:  r.id
        };
        var tmp = Date.now() + Math.random();
        TASKS.unshift(Object.assign({id:tmp}, task));
        created++;
        apiCall('addTask', task, function(){});
      }
    });
  }

  if(created > 0){
    localStorage.setItem('ff_tasks', JSON.stringify(TASKS));
    renderAll();
    toast('ğŸ” '+created+' compromisso'+(created>1?'s recorrentes':'  recorrente')+' criado'+(created>1?'s':'')+'!');
  }
}

function addRecur(tx){
  var r = Object.assign({ id: Date.now() }, tx);
  RECUR.unshift(r);
  saveRecur();
  apiCall('addRecur', r, function(err){
    if(err) toast('âš ï¸ RecorrÃªncia salva sÃ³ localmente','err');
  });
}

function addTx(){
  var desc=document.getElementById('tx-desc').value.trim();
  var val =parseFloat(document.getElementById('tx-val').value);
  var cat =document.getElementById('tx-cat').value;
  var date=document.getElementById('tx-date').value;
  if(!desc){toast('âš ï¸ Informe a descriÃ§Ã£o','err');return;}
  if(!val||val<=0){toast('âš ï¸ Informe o valor','err');return;}
  if(!date){toast('âš ï¸ Informe a data','err');return;}
  var btn=document.getElementById('btn-add-tx'); btn.disabled=true;
  var tx={type:curTxType,desc:desc,value:val,cat:cat,date:date};
  var tmp=Date.now(); TXS.unshift(Object.assign({id:tmp},tx)); renderAll();

  apiCall('addTransaction',tx,function(err){
    if(err){ TXS=TXS.filter(function(t){return t.id!==tmp;}); renderAll(); toast('âŒ Erro ao salvar','err'); }
    else{ syncAll(); toast(curTxType==='exp'?'âœ… Despesa registrada!':'âœ… Receita registrada!'); }
    btn.disabled=false;
  });
  document.getElementById('tx-desc').value='';
  document.getElementById('tx-val').value='';
}

function delTx(id){
  var bk=[].concat(TXS);
  TXS=TXS.filter(function(t){return String(t.id)!==String(id);}); renderAll();
  apiCall('deleteTransaction',{id:id},function(err){
    if(err){TXS=bk;renderAll();toast('âŒ Erro ao remover','err');}
    else toast('ğŸ—‘ï¸ Removido');
  });
}

function filteredTxs(){
  var today = ymd(new Date());
  return TXS.filter(function(t){
    if(!ymds(t.date).startsWith(selMonth)) return false;
    if(t.type !== 'inc' && t.type !== 'exp') return false;
    // Saldo sÃ³ computa transaÃ§Ãµes com data <= hoje
    // (transaÃ§Ãµes futuras sÃ£o projeÃ§Ãµes, nÃ£o realizadas)
    if(ymds(t.date) > today) return false;
    return true;
  });
}

function validTxs(){
  // Todas as transaÃ§Ãµes vÃ¡lidas (sem filtro de data â€” para histÃ³rico)
  return TXS.filter(function(t){
    return t.type === 'inc' || t.type === 'exp';
  });
}

// SÃ³ transaÃ§Ãµes realizadas (data <= hoje) â€” para saldo e resumo
function realizedTxs(){
  var today = ymd(new Date());
  return TXS.filter(function(t){
    return (t.type === 'inc' || t.type === 'exp') && ymds(t.date) <= today;
  });
}

function renderBal(){
  var b=balOf(filteredTxs());
  var v=document.getElementById('bal-val');
  // Mostra valor absoluto (sem sinal de menos), vermelho se negativo
  v.textContent=fmtBRL(Math.abs(b.b));
  v.className=b.b<0?'neg':'';
  document.getElementById('bi').textContent=fmtBRL(b.i);
  document.getElementById('be').textContent=fmtBRL(b.e);
}

function renderHist(){
  var months=[...new Set(validTxs().map(function(t){return ymds(t.date).substring(0,7);}))].sort().reverse();
  var mf=document.getElementById('mf-row');
  mf.innerHTML=months.map(function(m){
    var p=m.split('-');
    var lbl=new Date(p[0],parseInt(p[1])-1,1).toLocaleDateString('pt-BR',{month:'short',year:'2-digit'});
    return '<button class="mfc'+(m===selMonth?' on':'')+ '" onclick="selMon(\''+m+'\')">'+lbl+'</button>';
  }).join('');
  var txs=filteredTxs();
  var el=document.getElementById('tx-list');
  if(!txs.length){el.innerHTML=emptyHTML('ğŸ“­','Nenhum lanÃ§amento','Nenhum registro neste perÃ­odo');return;}
  el.innerHTML=txs.map(txCard).join('');
}

function selMon(m){
  selMonth=m;
  var p=m.split('-');
  document.getElementById('cat-month-lbl').textContent=
    new Date(p[0],parseInt(p[1])-1,1).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  renderAll();
  if(curFinTab!=='hist') ftab('hist');
}

function renderCat(){
  var txs=filteredTxs().filter(function(t){return t.type==='exp';});
  var el=document.getElementById('cat-list');
  if(!txs.length){el.innerHTML=emptyHTML('ğŸ“Š','Sem despesas','Adicione despesas para ver o resumo');return;}
  var bc={};
  txs.forEach(function(t){bc[t.cat]=(bc[t.cat]||0)+parseFloat(t.value||0);});
  var total=Object.values(bc).reduce(function(a,b){return a+b;},0);
  var sorted=Object.entries(bc).sort(function(a,b){return b[1]-a[1];});
  el.innerHTML=sorted.map(function(x){
    var pct=Math.round(x[1]/total*100);
    return '<div class="cati"><div class="cati-hdr"><div class="cati-name">'+x[0]+'</div><div class="cati-amt">-'+fmtBRL(x[1])+'</div></div><div class="bar-bg"><div class="bar-fg" style="width:'+pct+'%"></div></div></div>';
  }).join('');
}

function txCard(t){
  var tp=(t.type==='inc')?'inc':'exp';
  var ico=tp==='exp'?'ğŸ”´':'ğŸŸ¢';
  var sig=tp==='exp'?'-':'+';
  var sid=String(t.id);
  return '<div class="txi">'+
    '<div class="txi-ico '+tp+'">'+ico+'</div>'+
    '<div class="txi-info">'+
      '<div class="txi-desc">'+esc(t.desc)+'</div>'+
      '<div class="txi-meta"><span class="txi-cat">'+esc(t.cat||'')+'</span><span>'+fmtDate(t.date)+'</span></div>'+
    '</div>'+
    '<div class="txi-val '+tp+'">'+sig+fmtBRL(parseFloat(t.value||0))+'</div>'+
    '<button class="tdel" data-txdel="'+sid+'">ğŸ—‘ï¸</button>'+
  '</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FINANCE CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFinView(v){
  curFinView=v;
  ['day','week','month','future'].forEach(function(x){
    document.getElementById('fvw-'+x).style.display = x===v?'block':'none';
    document.getElementById('fv-'+x).classList.toggle('on', x===v);
  });
  renderFinView();
}

function renderFinView(){
  if(curFinView==='day')    renderFD();
  if(curFinView==='week')   renderFW();
  if(curFinView==='month')  renderFM();
  if(curFinView==='future') renderFuture();
}

function txsOn(d){ var target=ymd(d); return validTxs().filter(function(t){return ymds(t.date)===target;}); }
function txsIn(from,to){ return validTxs().filter(function(t){var d=ymds(t.date);return d>=from&&d<=to;}); }

function balMini(id,b){
  document.getElementById(id).innerHTML=
    '<div class="bmc"><div class="bmc-l i">â†‘ Receitas</div><div class="bmc-v pos">'+fmtBRL(b.i)+'</div></div>'+
    '<div class="bmc"><div class="bmc-l e">â†“ Despesas</div><div class="bmc-v neg">'+fmtBRL(b.e)+'</div></div>';
}

function groupedTxHTML(txs){
  if(!txs.length) return emptyHTML('ğŸ’¸','Nenhum lanÃ§amento','Nenhuma transaÃ§Ã£o neste perÃ­odo');
  var byD={};
  txs.forEach(function(t){ var d=ymds(t.date); if(!byD[d])byD[d]=[]; byD[d].push(t); });
  var tod=ymd(new Date());
  return Object.keys(byD).sort().reverse().map(function(d){
    var p=d.split('-');
    var lbl=new Date(p[0],parseInt(p[1])-1,parseInt(p[2])).toLocaleDateString('pt-BR',{weekday:'short',day:'numeric',month:'short'});
    var isT=d===tod;
    return '<div class="glbl'+(isT?' g-today':'')+'">'+( isT?'â˜€ï¸ ':'' )+lbl+' <span class="gbadge">'+byD[d].length+'</span></div>'+byD[d].map(txCard).join('');
  }).join('');
}

// FIN DAY
function renderFD(){
  var tod=ymd(new Date()); var d=ymd(fdDate); var isT=d===tod;
  document.getElementById('fd-date').textContent=isT
    ?'Hoje, '+fdDate.toLocaleDateString('pt-BR',{day:'numeric',month:'long'})
    :fdDate.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long'});
  document.getElementById('fd-sub').textContent=isT?'â˜€ï¸ hoje':fdDate.getFullYear();
  var txs=txsOn(fdDate); var b=balOf(txs); balMini('fd-bal',b);
  document.getElementById('fd-list').innerHTML=txs.length
    ?txs.map(txCard).join('')
    :emptyHTML('ğŸ’¸','Nenhum lanÃ§amento neste dia','');
}
function shiftFD(n){ fdDate.setDate(fdDate.getDate()+n); renderFD(); }

// FIN WEEK
function renderFW(){
  var days=['Seg','Ter','Qua','Qui','Sex','SÃ¡b','Dom'];
  var tod=ymd(new Date());
  var we=new Date(fwStart); we.setDate(we.getDate()+6);
  document.getElementById('fw-lbl').textContent=
    fwStart.toLocaleDateString('pt-BR',{day:'numeric',month:'short'})+' â€“ '+
    we.toLocaleDateString('pt-BR',{day:'numeric',month:'short'});
  var dates=[]; var stripH='';
  for(var i=0;i<7;i++){
    var d=new Date(fwStart); d.setDate(d.getDate()+i);
    var dy=ymd(d); dates.push(dy);
    var dayTxs=txsOn(d);
    var hasI=dayTxs.some(function(t){return t.type==='inc';});
    var hasE=dayTxs.some(function(t){return t.type==='exp';});
    stripH+='<div class="wdc"><div class="wdc-lbl">'+days[i]+'</div>'+
      '<div class="wdc-num'+(dy===tod?' today':'')+'" onclick="finWkDay(\''+dy+'\')">'+d.getDate()+'</div>'+
      '<div class="wdc-dots">'+(hasI?'<div class="dot" style="background:var(--green)"></div>':'')+
      (hasE?'<div class="dot" style="background:var(--red)"></div>':'')+'</div></div>';
  }
  document.getElementById('fw-strip').innerHTML=stripH;
  var allTxs=txsIn(dates[0],dates[6]);
  balMini('fw-bal',balOf(allTxs));
  document.getElementById('fw-list').innerHTML=groupedTxHTML(allTxs);
}
function shiftFW(n){ fwStart.setDate(fwStart.getDate()+n*7); renderFW(); }
function finWkDay(d){ fdDate=new Date(d+'T00:00:00'); setFinView('day'); }

// FIN MONTH
function renderFM(){
  var yr=fmDate.getFullYear(); var mo=fmDate.getMonth();
  var tod=ymd(new Date());
  document.getElementById('fm-lbl').textContent=
    fmDate.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  var dh=['Seg','Ter','Qua','Qui','Sex','SÃ¡b','Dom'];
  var gh=dh.map(function(d){return '<div class="mgh">'+d+'</div>';}).join('');
  var fd=new Date(yr,mo,1); var ld=new Date(yr,mo+1,0);
  var off=fd.getDay()-1; if(off<0)off=6;
  var rows=Math.ceil((off+ld.getDate())/7);
  for(var i=0;i<rows*7;i++){
    var dn=i-off+1;
    if(dn<1||dn>ld.getDate()){gh+='<div class="mgc om"><div class="mgn"></div></div>';continue;}
    var d=new Date(yr,mo,dn); var dy=ymd(d);
    var isT=dy===tod;
    var dTxs=txsOn(d);
    var hasI=dTxs.some(function(t){return t.type==='inc';});
    var hasE=dTxs.some(function(t){return t.type==='exp';});
    gh+='<div class="mgc'+(isT?' today':'')+'" onclick="finMoDay(\''+dy+'\')">'+
      '<div class="mgn">'+dn+'</div>'+
      '<div class="mgc-dots">'+
      (hasI?'<div class="dot" style="background:var(--green)"></div>':'')+
      (hasE?'<div class="dot" style="background:var(--red)"></div>':'')+
      '</div></div>';
  }
  document.getElementById('fm-grid').innerHTML=gh;
  var ms=yr+'-'+pad(mo+1);
  var moTxs=TXS.filter(function(t){return ymds(t.date).startsWith(ms);}).sort(function(a,b){return ymds(a.date).localeCompare(ymds(b.date));});
  balMini('fm-bal',balOf(moTxs));
  document.getElementById('fm-list').innerHTML=groupedTxHTML(moTxs);
}
function shiftFM(n){ fmDate.setMonth(fmDate.getMonth()+n); renderFM(); }
function finMoDay(d){ fdDate=new Date(d+'T00:00:00'); setFinView('day'); }

// FUTURE
function renderFuture(){
  var now=new Date(); var html='';
  for(var mOff=0;mOff<3;mOff++){
    var d=new Date(now.getFullYear(),now.getMonth()+mOff,1);
    var yr=d.getFullYear(); var mo=d.getMonth();
    var ms=yr+'-'+pad(mo+1);
    var mTxs=TXS.filter(function(t){return ymds(t.date).startsWith(ms);});
    var b=balOf(mTxs);
    var isCur=mOff===0;
    var projI=0,projE=0;
    if(!isCur){
      var past=[];
      for(var p=1;p<=2;p++){
        var pd=new Date(now.getFullYear(),now.getMonth()-p,1);
        var ps=pd.getFullYear()+'-'+pad(pd.getMonth()+1);
        var ptx=TXS.filter(function(t){return ymds(t.date).startsWith(ps);});
        if(ptx.length) past.push(balOf(ptx));
      }
      if(past.length){
        projI=past.reduce(function(s,x){return s+x.i;},0)/past.length;
        projE=past.reduce(function(s,x){return s+x.e;},0)/past.length;
      }
    }
    var saldo=isCur?b.b:(projI-projE);
    var ld=new Date(yr,mo+1,0).getDate();
    var whtml='';
    for(var day=1;day<=ld;day+=7){
      var wEnd=Math.min(day+6,ld);
      var from=yr+'-'+pad(mo+1)+'-'+pad(day);
      var to=yr+'-'+pad(mo+1)+'-'+pad(wEnd);
      var wTxs=txsIn(from,to); var wb=balOf(wTxs);
      whtml+='<div class="fwr" onclick="finWkDay(\''+from+'\')">'+
        '<div class="fwl">'+pad(day)+'/'+pad(mo+1)+' â€“ '+pad(wEnd)+'/'+pad(mo+1)+'</div>'+
        '<div class="fwa">'+
        (wTxs.length
          ?'<span class="i">+'+fmtBRL(wb.i)+'</span><span class="e">-'+fmtBRL(wb.e)+'</span>'
          :'<span style="color:var(--t3);font-size:11px">sem dados</span>')+
        '</div></div>';
    }
    html+='<div class="fmb">'+
      '<div class="fmb-title"><span>'+(isCur?'â˜€ï¸ ':'')+d.toLocaleDateString('pt-BR',{month:'long',year:'numeric'})+'</span>'+
      '<span class="fproj '+(saldo>=0?'pos':'neg')+'">'+(isCur?'':' ~ ')+fmtBRL(Math.abs(saldo))+' '+(saldo>=0?'sobra':'dÃ©ficit')+'</span></div>'+
      whtml+'</div>';
  }
  document.getElementById('future-body').innerHTML=html||emptyHTML('ğŸ”®','Sem dados','Adicione transaÃ§Ãµes para ver a projeÃ§Ã£o');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TASKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTF(){
  tfOpen=!tfOpen;
  document.getElementById('tf-body').style.display=tfOpen?'block':'none';
  document.getElementById('tf-arrow').style.transform=tfOpen?'':'rotate(-90deg)';
}

function onTaskTypeChange(){
  var type = document.getElementById('t-type').value;
  var valRow  = document.getElementById('t-val-row');
  var catWrap = document.getElementById('t-cat-wrap');
  var note    = document.getElementById('t-task-note');
  if(type === 'task'){
    valRow.style.display  = 'none';
    note.style.display    = 'block';
  } else {
    valRow.style.display  = '';
    note.style.display    = 'none';
    // ajustar categoria padrÃ£o
    var cat = document.getElementById('t-cat');
    if(type==='inc') cat.value = 'ğŸ’° SalÃ¡rio';
    else             cat.value = 'ğŸ“¦ Outros';
  }
}

function addTask(){
  var desc=document.getElementById('t-desc').value.trim();
  var type=document.getElementById('t-type').value;
  var dead=document.getElementById('t-dead').value;
  var valEl=document.getElementById('t-val');
  var val =type!=='task' ? parseFloat(valEl.value)||null : null;
  var cat = type!=='task' ? (document.getElementById('t-cat').value||'ğŸ“¦ Outros') : '';
  if(!desc){toast('âš ï¸ Informe a descriÃ§Ã£o','err');return;}
  if(type!=='task' && (!val||val<=0)){toast('âš ï¸ Informe o valor para '+( type==='exp'?'despesa':'receita'),'err');return;}
  var btn=document.getElementById('btn-add-task'); btn.disabled=true;
  var task={desc:desc,type:type,deadline:dead,value:val,cat:cat,status:'pend'};
  var tmp=Date.now(); TASKS.unshift(Object.assign({id:tmp},task)); renderTasks();
  if(curRecur){
    var newRecurId = Date.now();
    addRecur({id:newRecurId,type:type,desc:desc,value:val||0,cat:cat||'',date:dead||ymd(new Date())});
    task.recurId = newRecurId; // salvar referÃªncia na tarefa
    curRecur=false;
    var togR=document.getElementById('recur-toggle');
    var dotR=document.getElementById('recur-dot');
    var badgeR=document.getElementById('recur-badge');
    if(togR) togR.classList.remove('on');
    if(dotR) dotR.textContent='';
    if(badgeR) badgeR.textContent='inativo';
  }
  apiCall('addTask',task,function(err){
    if(err){TASKS=TASKS.filter(function(t){return t.id!==tmp;});renderTasks();toast('âŒ Erro ao criar','err');}
    else{syncAll();toast('ğŸ“Œ Compromisso criado!');}
    btn.disabled=false;
  });
  document.getElementById('t-desc').value='';
  document.getElementById('t-val').value='';
  if(document.getElementById('t-cat')) document.getElementById('t-cat').value='ğŸ“¦ Outros';
}

function toggleTask(id){
  var t=TASKS.find(function(x){return String(x.id)===String(id);});
  if(!t)return;
  // Reabrir: volta para pendente
  if(t.status==='done'){
    t.status='pend'; renderAll();
    apiCall('updateTask',{id:id,status:'pend'},function(err){
      if(err){t.status='done';renderAll();toast('âŒ Erro','err');}
      else{ renderAll(); toast('ğŸ”„ Reaberto'); }
    });
    return;
  }
  // Concluir: se tem valor â†’ abre modal de comprovante
  if(t.value && parseFloat(t.value)>0){
    openComprovModal(id);
  } else {
    // Sem valor: conclui direto
    t.status='done'; renderAll();
    apiCall('updateTask',{id:id,status:'done'},function(err){
      if(err){t.status='pend';renderAll();toast('âŒ Erro','err');}
      else{ renderAll(); toast('âœ… ConcluÃ­do!'); }
    });
  }
}

var comprovModalTaskId = null;
var taskComprovFile = null;

function openComprovModal(id){
  comprovModalTaskId = id;
  taskComprovFile = null;
  document.getElementById('task-comprov-preview').style.display='none';
  document.getElementById('task-comprov-bar').style.width='0%';
  document.getElementById('task-comprov-progress').style.display='none';
  var modal = document.getElementById('comprov-modal');
  modal.style.display = 'flex';

  // bind file input
  var inp = document.getElementById('task-comprov-file');
  inp.value = '';
  inp.onchange = function(){
    taskComprovFile = inp.files[0];
    if(!taskComprovFile) return;
    var prev = document.getElementById('task-comprov-preview');
    prev.style.display='block';
    prev.textContent = (taskComprovFile.type.indexOf('pdf')!==-1?'ğŸ“•':'ğŸ–¼ï¸')+' '+taskComprovFile.name+' ('+(taskComprovFile.size/1024).toFixed(1)+' KB)';
  };
}

function closeComprovModal(){
  // Fechar sem comprovante â€” sÃ³ marcar como done
  var id = comprovModalTaskId;
  document.getElementById('comprov-modal').style.display='none';
  if(id) chgTaskStatus(id, 'done');
  comprovModalTaskId = null;
}

function sendTaskComprov(){
  var id = comprovModalTaskId;
  if(!id) return;
  var btn = document.getElementById('task-comprov-send');
  btn.disabled = true;

  function finalize(url){
    document.getElementById('comprov-modal').style.display='none';
    var t = TASKS.find(function(x){ return String(x.id)===String(id); });
    if(!t){ btn.disabled=false; return; }
    if(url) t.comprovUrl = url;
    t.status = 'done';
    renderTasks();

    // Salvar status + comprovUrl no servidor
    apiCall('updateTask', {id:id, status:'done', comprovUrl:url||''}, function(){});

    // Se tem valor â†’ lanÃ§ar automaticamente em FinanÃ§as
    if(t.value && parseFloat(t.value)>0 && t.type !== 'task'){
      var tx = {
        type:  t.type==='inc' ? 'inc' : 'exp',
        desc:  t.desc,
        value: parseFloat(t.value),
        cat:   t.cat || (t.type==='inc'?'â­ Extra':'ğŸ“¦ Outros'),
        date:  ymd(new Date()),
        fromAgenda: true
      };
      var tmpTx = Date.now();
      TXS.unshift(Object.assign({id:tmpTx}, tx));
      localStorage.setItem('ff_txs', JSON.stringify(TXS));
      apiCall('addTransaction', tx, function(err){
        if(err) TXS = TXS.filter(function(x){ return x.id!==tmpTx; });
        else localStorage.setItem('ff_txs', JSON.stringify(TXS));
        renderAll();
      });
    }

    // Salvar comprovante nos Docs se houver URL
    if(url){
      var nome = t.desc + ' â€” ' + ymd(new Date());
      var docEntry = {name:nome, url:url, type:'img', pasta:'Financeiro', subpasta:'Comprovantes'};
      var tmp2 = Date.now();
      DOCS.unshift(Object.assign({id:tmp2}, docEntry));
      localStorage.setItem('ff_docs', JSON.stringify(DOCS));
      apiCall('addDoc', docEntry, function(){});
      toast('âœ… ConcluÃ­do + comprovante + lanÃ§ado em FinanÃ§as!');
    } else {
      toast(t.value && parseFloat(t.value)>0 ? 'âœ… ConcluÃ­do + lanÃ§ado em FinanÃ§as!' : 'âœ… ConcluÃ­do!');
    }
    renderAll();
    btn.disabled = false;
    comprovModalTaskId = null;
  }

  if(!taskComprovFile){
    finalize(null);
    return;
  }

  // upload
  var prog = document.getElementById('task-comprov-progress');
  var bar  = document.getElementById('task-comprov-bar');
  prog.style.display='block'; bar.style.width='30%';

  var t3 = TASKS.find(function(x){ return String(x.id)===String(id); });
  var fname = ymd(new Date()).replace(/-/g,'')+'_'+(t3?t3.desc:'comprovante').replace(/[^a-zA-Z0-9Ã€-Ãº ]/g,'').substring(0,30).trim();

  prepareFileB64(taskComprovFile, function(b64, mime){
    bar.style.width='60%';
    apiPost('uploadComprovante',{name:fname, mimeType:mime, data:b64}, function(err,d){
      bar.style.width='100%';
      setTimeout(function(){ prog.style.display='none'; },400);
      if(err||!d||!d.ok){ toast('âŒ Erro no upload: '+(err?err.message:(d&&d.error)||''),'err'); finalize(null); return; }
      finalize(d.url);
    });
  });
}

function chgTaskStatus(id,s){
  var t=TASKS.find(function(x){return String(x.id)===String(id);});
  if(!t)return; var old=t.status; t.status=s; renderTasks();
  apiCall('updateTask',{id:id,status:s},function(err){
    if(err){t.status=old;renderTasks();toast('âŒ Erro','err');}
  });
}

function delTask(id){
  var bk=[].concat(TASKS);
  TASKS=TASKS.filter(function(t){return String(t.id)!==String(id);}); renderTasks();
  apiCall('deleteTask',{id:id},function(err){
    if(err){TASKS=bk;renderTasks();toast('âŒ Erro','err');}
    else toast('ğŸ—‘ï¸ Removido');
  });
}

function setTaskView(v){
  curTaskView=v;
  ['list','day','week','month','plan'].forEach(function(x){
    document.getElementById('tvw-'+x).style.display=x===v?'block':'none';
    document.getElementById('tv-'+x).classList.toggle('on',x===v);
  });
  renderTasks();
}

function renderTasks(){
  if(curTaskView==='list')  renderTL();
  if(curTaskView==='day')   renderTD();
  if(curTaskView==='week')  renderTW();
  if(curTaskView==='month') renderTM();
  if(curTaskView==='plan')  renderTP();
  bindTaskEvents();
}

function bindTaskEvents(){
  // NÃ£o faz nada â€” usamos delegaÃ§Ã£o global no document (inicializada em init)
}

function initTaskDelegation(){
  document.addEventListener('click', function(e){
    var rmBtn = e.target.closest('.recur-manage-btn');
    if(rmBtn){ e.stopPropagation(); openRecurModal(rmBtn.getAttribute('data-rid')); return; }
    var chk = e.target.closest('[data-chk]');
    if(chk){ toggleTask(chk.getAttribute('data-chk')); return; }
    var del = e.target.closest('[data-del]');
    if(del){ delTask(del.getAttribute('data-del')); return; }
    var txdel = e.target.closest('[data-txdel]');
    if(txdel){ delTx(txdel.getAttribute('data-txdel')); return; }
  });
}

function taskCard(t,wrap){
  var done=t.status==='done';
  var stag=done?'<span class="tag done">âœ… ConcluÃ­do</span>':'<span class="tag pend">â³ Pendente</span>';
  var ttag=t.type==='inc'?'<span class="tag tinc">ğŸŸ¢ Receita</span>'
    :t.type==='task'?'<span class="tag ttask">ğŸ“Œ Compromisso</span>'
    :'<span class="tag texp">ğŸ”´ Despesa</span>';
  var tod=ymd(new Date());
  var ov=t.deadline&&ymds(t.deadline)<tod&&!done;
  var dead=t.deadline?'<span class="'+(ov?'ov':'')+'">ğŸ“… '+fmtDate(t.deadline)+(ov?' âš ï¸':'')+'</span>':'';
  var comprovHTML=t.comprovUrl
    ?'<a href="'+esc(t.comprovUrl)+'" target="_blank" class="task-comprov-link">ğŸ“ Ver comprovante</a>':'';
  // Ãcone de recorrÃªncia â€” por recurId ou por desc (fallback)
  var recurEntry = null;
  if(t.recurId){
    recurEntry = RECUR.find(function(r){ return String(r.id)===String(t.recurId); });
  }
  if(!recurEntry){
    recurEntry = RECUR.find(function(r){ return r.desc===t.desc; });
  }
  var recurTag = recurEntry
    ? '<button class="tag trecur recur-manage-btn" data-rid="'+String(recurEntry.id)+'" title="Recorrente mensal â€” clique para gerenciar">ğŸ” Mensal</button>'
    : '';
  var sid=String(t.id);
  var html='<div class="taski'+(wrap?' '+wrap:'')+'" data-id="'+sid+'">'+
    '<div class="taski-hdr">'+
    '<div class="chk'+(done?' done':'')+'" data-chk="'+sid+'">'+(done?'âœ“':'')+'</div>'+
    '<div class="tname'+(done?' done':'')+'">'+esc(t.desc)+'</div>'+
    '<button class="tdel2" data-del="'+sid+'">ğŸ—‘ï¸</button>'+
    '</div>'+
    '<div class="tags">'+stag+ttag+recurTag+'</div>'+
    '<div class="tmeta">'+dead+
    (t.value?'<span>ğŸ’° '+fmtBRL(parseFloat(t.value))+'</span>':'')+
    (done?comprovHTML:'')+
    '</div></div>';
  return html;
}

// LIST VIEW
function renderTL(){
  var tod=ymd(new Date());
  var open=TASKS.filter(function(t){return t.status!=='done';});
  var done=TASKS.filter(function(t){return t.status==='done';});
  var ov=open.filter(function(t){return t.deadline&&ymds(t.deadline)<tod;});
  var tdy=open.filter(function(t){return ymds(t.deadline)===tod;});
  var soon=open.filter(function(t){return t.deadline&&ymds(t.deadline)>tod;});
  var nd=open.filter(function(t){return !t.deadline;});
  var h='';
  if(ov.length)   h+='<div class="glbl g-overdue">âš ï¸ Atrasadas <span class="gbadge">'+ov.length+'</span></div>'+ov.map(function(t){return taskCard(t);}).join('');
  if(tdy.length)  h+='<div class="glbl g-today">â˜€ï¸ Hoje <span class="gbadge">'+tdy.length+'</span></div>'+tdy.map(function(t){return taskCard(t);}).join('');
  if(soon.length) h+='<div class="glbl g-soon">ğŸ“… PrÃ³ximas <span class="gbadge">'+soon.length+'</span></div>'+soon.map(function(t){return taskCard(t);}).join('');
  if(nd.length)   h+='<div class="glbl">ğŸ“Œ Sem prazo <span class="gbadge">'+nd.length+'</span></div>'+nd.map(function(t){return taskCard(t);}).join('');
  if(!open.length)h=emptyHTML('ğŸ‰','Tudo em dia!','Nenhum compromisso em aberto');
  document.getElementById('task-open').innerHTML=h;
  document.getElementById('task-done').innerHTML=done.length
    ?done.slice(0,10).map(function(t){return taskCard(t);}).join('')
    :emptyHTML('','Nenhuma concluÃ­da ainda','');
}

// TASK DAY
function renderTD(){
  var tod=ymd(new Date()); var d=ymd(tdDate); var isT=d===tod;
  document.getElementById('td-date').textContent=isT
    ?'Hoje, '+tdDate.toLocaleDateString('pt-BR',{day:'numeric',month:'long'})
    :tdDate.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long'});
  document.getElementById('td-sub').textContent=isT?'â˜€ï¸ hoje':tdDate.toLocaleDateString('pt-BR',{year:'numeric'});
  var tasks=TASKS.filter(function(t){return ymds(t.deadline)===d;});
  document.getElementById('td-list').innerHTML=tasks.length
    ?tasks.map(function(t){return taskCard(t);}).join('')
    :emptyHTML('âœ¨','Nenhum compromisso neste dia','Crie uma tarefa com prazo em '+fmtDate(d));
}
function shiftTD(n){ tdDate.setDate(tdDate.getDate()+n); renderTD(); }

// TASK WEEK
function renderTW(){
  var days=['Seg','Ter','Qua','Qui','Sex','SÃ¡b','Dom'];
  var tod=ymd(new Date());
  var we=new Date(twStart); we.setDate(we.getDate()+6);
  document.getElementById('tw-lbl').textContent=
    twStart.toLocaleDateString('pt-BR',{day:'numeric',month:'short'})+' â€“ '+
    we.toLocaleDateString('pt-BR',{day:'numeric',month:'short'});
  var dates=[]; var sh=''; var total=0;
  for(var i=0;i<7;i++){
    var d=new Date(twStart); d.setDate(d.getDate()+i);
    var dy=ymd(d); dates.push(dy);
    var has=TASKS.some(function(t){return ymds(t.deadline)===dy;});
    sh+='<div class="wdc"><div class="wdc-lbl">'+days[i]+'</div>'+
      '<div class="wdc-num'+(dy===tod?' today':'')+'" onclick="taskWkDay(\''+dy+'\')">'+d.getDate()+'</div>'+
      '<div class="wdc-dots">'+(has?'<div class="dot" style="background:var(--yellow)"></div>':'')+'</div></div>';
  }
  document.getElementById('tw-strip').innerHTML=sh;
  var h='';
  dates.forEach(function(dy){
    var dt=TASKS.filter(function(t){return ymds(t.deadline)===dy;});
    if(!dt.length)return; total+=dt.length;
    var p=dy.split('-');
    var lbl=new Date(p[0],parseInt(p[1])-1,parseInt(p[2])).toLocaleDateString('pt-BR',{weekday:'short',day:'numeric',month:'short'});
    var isT=dy===tod;
    h+='<div class="glbl'+(isT?' g-today':'')+'">'+( isT?'â˜€ï¸ ':'')+lbl+' <span class="gbadge">'+dt.length+'</span></div>'+dt.map(function(t){return taskCard(t);}).join('');
  });
  if(!total) h=emptyHTML('ğŸ“…','Semana livre!','Nenhum compromisso nesta semana');
  document.getElementById('tw-list').innerHTML=h;
}
function shiftTW(n){ twStart.setDate(twStart.getDate()+n*7); renderTW(); }
function taskWkDay(d){ tdDate=new Date(d+'T00:00:00'); setTaskView('day'); }

// TASK MONTH
function renderTM(){
  var yr=tmDate.getFullYear(); var mo=tmDate.getMonth();
  var tod=ymd(new Date());
  document.getElementById('tm-lbl').textContent=
    tmDate.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  var dh=['Seg','Ter','Qua','Qui','Sex','SÃ¡b','Dom'];
  var gh=dh.map(function(d){return '<div class="mgh">'+d+'</div>';}).join('');
  var fd=new Date(yr,mo,1); var ld=new Date(yr,mo+1,0);
  var off=fd.getDay()-1; if(off<0)off=6;
  var rows=Math.ceil((off+ld.getDate())/7);
  for(var i=0;i<rows*7;i++){
    var dn=i-off+1;
    if(dn<1||dn>ld.getDate()){gh+='<div class="mgc om"><div class="mgn"></div></div>';continue;}
    var d=new Date(yr,mo,dn); var dy=ymd(d);
    var isT=dy===tod;
    var dTasks=TASKS.filter(function(t){return ymds(t.deadline)===dy&&t.status!=='done';});
    var dots=dTasks.slice(0,3).map(function(t){
      var c=t.status==='done'?'var(--green)':t.status==='prog'?'var(--blue)':'var(--yellow)';
      return '<div class="dot" style="background:'+c+'"></div>';
    }).join('');
    gh+='<div class="mgc'+(isT?' today':'')+'" onclick="taskMoDay(\''+dy+'\')">'+
      '<div class="mgn">'+dn+'</div>'+
      '<div class="mgc-dots">'+dots+'</div></div>';
  }
  document.getElementById('tm-grid').innerHTML=gh;
  var ms=yr+'-'+pad(mo+1);
  var moTasks=TASKS.filter(function(t){return t.deadline&&ymds(t.deadline).startsWith(ms)&&t.status!=='done';}).sort(function(a,b){return String(a.deadline).localeCompare(String(b.deadline));});
  var h='';
  if(moTasks.length){
    var fd2=new Date(yr,mo,1);
    var byW={};
    moTasks.forEach(function(t){
      var dd=new Date(t.deadline+'T00:00:00');
      var w=Math.ceil((dd.getDate()+fd2.getDay()-1)/7);
      if(!byW[w])byW[w]=[]; byW[w].push(t);
    });
    Object.entries(byW).forEach(function(e){
      h+='<div class="glbl g-soon">Semana '+e[0]+' <span class="gbadge">'+e[1].length+'</span></div>'+e[1].map(function(t){return taskCard(t);}).join('');
    });
  } else {
    h=emptyHTML('ğŸ“†','Nenhum compromisso neste mÃªs','');
  }
  document.getElementById('tm-list').innerHTML=h;
}
function shiftTM(n){ tmDate.setMonth(tmDate.getMonth()+n); renderTM(); }
function taskMoDay(d){ tdDate=new Date(d+'T00:00:00'); setTaskView('day'); }

// TASK PLAN â€” prÃ³ximos 90 dias agrupado por semana e mÃªs
function renderTP(){
  var now=new Date(); now.setHours(0,0,0,0);
  var html='';

  for(var mOff=0;mOff<3;mOff++){
    var mDate=new Date(now.getFullYear(), now.getMonth()+mOff, 1);
    var yr=mDate.getFullYear(); var mo=mDate.getMonth();
    var ms=yr+'-'+pad(mo+1);
    var ld=new Date(yr,mo+1,0).getDate();
    var isCur=mOff===0;

    // tarefas do mÃªs
    var moTasks=TASKS.filter(function(t){
      return t.deadline && ymds(t.deadline).startsWith(ms) && t.status!=='done';
    });
    var doneCount=TASKS.filter(function(t){
      return t.deadline && ymds(t.deadline).startsWith(ms) && t.status==='done';
    }).length;
    var totalCount=moTasks.length+doneCount;

    var mLabel=mDate.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
    var summary=moTasks.length+' pendente'+(moTasks.length!==1?'s':'')+
      (doneCount?' Â· '+doneCount+' concluÃ­da'+(doneCount!==1?'s':''):'');

    // cabeÃ§alho do mÃªs
    html+='<div class="fmb">'+
      '<div class="fmb-title">'+
      '<span>'+(isCur?'â˜€ï¸ ':'')+mLabel+'</span>'+
      '<span style="font-size:11px;color:var(--t2)">'+summary+'</span>'+
      '</div>';

    // semanas do mÃªs
    var whtml='';
    var wNum=1;
    for(var day=1;day<=ld;day+=7){
      var wEnd=Math.min(day+6,ld);
      var from=yr+'-'+pad(mo+1)+'-'+pad(day);
      var to=yr+'-'+pad(mo+1)+'-'+pad(wEnd);

      // sÃ³ mostrar semanas a partir de hoje no mÃªs atual
      if(isCur && to < ymd(now)) { wNum++; continue; }

      var wTasks=TASKS.filter(function(t){
        var d=ymds(t.deadline);
        return t.deadline && d>=from && d<=to && t.status!=='done';
      });
      var wDone=TASKS.filter(function(t){
        var d=ymds(t.deadline);
        return t.deadline && d>=from && d<=to && t.status==='done';
      }).length;

      var dayLabel=pad(day)+'/'+pad(mo+1)+' â€“ '+pad(wEnd)+'/'+pad(mo+1);
      var hasOv=wTasks.some(function(t){ return ymds(t.deadline)<ymd(now); });

      // cabeÃ§alho da semana â€” clicÃ¡vel para ir para view semana
      whtml+='<div class="fwr" onclick="taskWkFrom(\'' +from+ '\')" style="'+(hasOv?'border-color:rgba(255,107,107,.3)':'')+'">'+
        '<div class="fwl">'+dayLabel+'</div>'+
        '<div class="fwa">'+
        (wTasks.length||wDone
          ?'<span style="color:var(--yellow)">'+wTasks.length+' pendente'+(wTasks.length!==1?'s':'')+'</span>'+
           (wDone?'<span style="color:var(--green)">'+wDone+' âœ…</span>':'')
          :'<span style="color:var(--t3);font-size:11px">sem tarefas</span>')+
        '</div></div>';

      // listar tarefas desta semana expandidas (sÃ³ mÃªs atual / prÃ³xima semana)
      if(wTasks.length && mOff<=1){
        whtml+=wTasks.map(function(t){return taskCard(t);}).join('');
      }
      wNum++;
    }

    html+=whtml+'</div>';
  }

  document.getElementById('tp-body').innerHTML = html ||
    emptyHTML('ğŸ”®','Sem compromissos planejados','Adicione compromissos com prazo para ver o planejamento');
}

function taskWkFrom(from){
  twStart=new Date(from+'T00:00:00');
  setTaskView('week');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EMPTY HTML
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOJE â€” painel matinal
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHoje(){
  var tod = ymd(new Date());
  var now = new Date(); now.setHours(0,0,0,0);

  // TransaÃ§Ãµes de hoje
  var todTxs = TXS.filter(function(t){ return ymds(t.date) === tod; });
  var pgtos  = todTxs.filter(function(t){ return t.type === 'exp'; });
  var recs   = todTxs.filter(function(t){ return t.type === 'inc'; });

  // Tarefas de hoje (nÃ£o concluÃ­das)
  var todTasks = TASKS.filter(function(t){
    return ymds(t.deadline) === tod && t.status !== 'done';
  });

  // Atrasados: transaÃ§Ãµes e tarefas de dias anteriores nÃ£o "concluÃ­das"
  // Para finanÃ§as: gastos futuros com data passada (nÃ£o marcados como pagos)
  // Para tarefas: deadline passou e status != done
  var atrasadoTasks = TASKS.filter(function(t){
    return t.deadline && ymds(t.deadline) < tod && t.status !== 'done';
  });
  // Gastos atrasados = transaÃ§Ãµes com data no passado que foram marcadas com status 'pending'
  // Como transaÃ§Ãµes nÃ£o tÃªm status de "pago", usamos sÃ³ tarefas como atrasadas
  // (O usuÃ¡rio pode registrar pagamentos como transaÃ§Ãµes normais no dia que pagar)

  // Atualizar cabeÃ§alho
  var now2 = new Date();
  var h = now2.getHours();
  var greeting = h < 12 ? 'â˜€ï¸ Bom dia!' : h < 18 ? 'ğŸŒ¤ï¸ Boa tarde!' : 'ğŸŒ™ Boa noite!';
  var gEl = document.getElementById('hoje-greeting');
  if(gEl) gEl.textContent = greeting + ' Seu resumo de hoje';
  document.getElementById('hoje-date-lbl').textContent =
    now2.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

  // Contadores
  document.getElementById('hc-pgto').textContent = pgtos.length;
  document.getElementById('hc-task').textContent = todTasks.length;
  document.getElementById('hc-rec').textContent  = recs.length;

  // Badges
  document.getElementById('hb-pgto').textContent = pgtos.length;
  document.getElementById('hb-rec').textContent  = recs.length;
  document.getElementById('hb-task').textContent = todTasks.length;
  document.getElementById('hb-atrasado').textContent = atrasadoTasks.length;

  // Mostrar/ocultar seÃ§Ãµes vazias
  document.getElementById('hs-pgto').style.display    = pgtos.length    ? 'block':'none';
  document.getElementById('hs-rec').style.display     = recs.length     ? 'block':'none';
  document.getElementById('hs-task').style.display    = todTasks.length ? 'block':'none';
  document.getElementById('hs-atrasado').style.display = atrasadoTasks.length ? 'block':'none';

  // Render pagamentos
  document.getElementById('hoje-pgto-list').innerHTML = pgtos.length
    ? pgtos.map(function(t){ return pgtoCard(t); }).join('')
    : '';

  // Render recebimentos
  document.getElementById('hoje-rec-list').innerHTML = recs.length
    ? recs.map(function(t){ return pgtoCard(t); }).join('')
    : '';

  // Render tarefas de hoje
  document.getElementById('hoje-task-list').innerHTML = todTasks.length
    ? todTasks.map(function(t){ return taskCard(t); }).join('')
    : '';

  // Render atrasados
  document.getElementById('hoje-atrasado-list').innerHTML = atrasadoTasks.length
    ? atrasadoTasks.map(function(t){ return taskCard(t); }).join('')
    : '';

  // Se tudo vazio, mostrar mensagem de parabÃ©ns
  if(!pgtos.length && !recs.length && !todTasks.length && !atrasadoTasks.length){
    document.getElementById('hs-pgto').style.display = 'block';
    document.getElementById('hoje-pgto-list').innerHTML =
      '<div class="hoje-empty"><div class="he-icon">ğŸ‰</div><div class="he-txt">Dia livre! Nenhum compromisso hoje.</div></div>';
  }
}

function pgtoCard(t){
  // Card de transaÃ§Ã£o estilo "a pagar/receber hoje"
  return '<div class="pgto-card">'+
    '<div class="pgto-icon '+ t.type +'">'+ (t.type==='exp'?'ğŸ’¸':'ğŸ’°') +'</div>'+
    '<div class="pgto-info">'+
      '<div class="pgto-desc">'+ esc(t.desc) +'</div>'+
      '<div class="pgto-meta"><span class="pgto-cat">'+ esc(t.cat) +'</span></div>'+
    '</div>'+
    '<div class="pgto-val '+ t.type +'">'+ (t.type==='exp'?'-':'+') + fmtBRL(parseFloat(t.value)) +'</div>'+
  '</div>';
}

function hojePgtoToggle(id){
  // Futura expansÃ£o: marcar pagamento como efetuado
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOCS â€” links para Google Drive
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var DOCS = JSON.parse(localStorage.getItem('ff_docs') || '[]');
var dfOpen = false;

var DOC_ICONS = {
  doc:    {ico:'ğŸ“„', bg:'rgba(66,133,244,.15)',  label:'Documento'},
  sheet:  {ico:'ğŸ“Š', bg:'rgba(52,168,83,.15)',   label:'Planilha'},
  pdf:    {ico:'ğŸ“•', bg:'rgba(234,67,53,.15)',   label:'PDF'},
  img:    {ico:'ğŸ–¼ï¸', bg:'rgba(255,160,0,.15)',   label:'Imagem'},
  slide:  {ico:'ğŸ“‘', bg:'rgba(251,188,4,.15)',   label:'ApresentaÃ§Ã£o'},
  folder: {ico:'ğŸ“', bg:'rgba(255,160,0,.15)',   label:'Pasta'},
  link:   {ico:'ğŸ”—', bg:'rgba(143,168,196,.15)', label:'Link'},
};

function normKey(s){
  // Remove acentos, trim, Title Case â€” evita "Joao" e "JoÃ£o" virarem grupos diferentes
  if(!s) return '';
  var r = s.trim()
    .normalize('NFD').replace(/[Ì€-Í¯]/g,'') // remove acentos
    .toLowerCase()
    .replace(/(?:^|\s)\S/g, function(a){ return a.toUpperCase(); }); // Title Case
  return r;
}

var PASTAS_PRINCIPAIS = [
  'Documentos Pessoais',
  'Empresa',
  'ImÃ³veis e Loteamentos',
  'Financeiro',
  'Outros'
];

function toggleDocsForm(){
  dfOpen=!dfOpen;
  document.getElementById('df-body').style.display = dfOpen?'flex':'none';
  document.getElementById('df-arrow').style.transform = dfOpen?'':'rotate(-90deg)';
}

function onPastaChange(){
  // Limpa subpasta ao trocar pasta principal
  var el = document.getElementById('d-subpasta');
  if(el) el.value = '';
}

function addDoc(){
  var nameEl    = document.getElementById('d-name');
  var urlEl     = document.getElementById('d-url');
  var typeEl    = document.getElementById('d-type');
  var pastaEl   = document.getElementById('d-pasta');
  var subEl     = document.getElementById('d-subpasta');
  var btn       = document.getElementById('btn-add-doc');

  if(!nameEl || !urlEl){ toast('âš ï¸ FormulÃ¡rio nÃ£o encontrado','err'); return; }

  var name     = nameEl.value.trim();
  var url      = urlEl.value.trim();
  var type     = typeEl    ? typeEl.value    : 'doc';
  var pasta    = pastaEl   ? pastaEl.value   : 'Outros';
  var subpasta = subEl     ? subEl.value.trim() : '';

  if(!name){ toast('âš ï¸ Informe o nome do arquivo','err'); return; }
  if(!url || url.indexOf('http')===-1){ toast('âš ï¸ Cole um link vÃ¡lido','err'); return; }

  // Limpar campos antes de tudo
  nameEl.value = '';
  urlEl.value  = '';
  if(subEl) subEl.value = '';

  if(btn) btn.disabled = true;
  toast('ğŸ’¾ Salvando...');

  var tmp = Date.now();
  var doc = { id:tmp, name:name, url:url, type:type, pasta:pasta, subpasta:subpasta };
  DOCS.unshift(doc);
  localStorage.setItem('ff_docs', JSON.stringify(DOCS));
  renderDocs();

  apiCall('addDoc', {name:name, url:url, type:type, pasta:pasta, subpasta:subpasta}, function(err, d){
    if(err){
      DOCS = DOCS.filter(function(x){ return x.id !== tmp; });
      localStorage.setItem('ff_docs', JSON.stringify(DOCS));
      renderDocs();
      toast('âŒ Erro ao salvar','err');
    } else {
      for(var i=0; i<DOCS.length; i++){
        if(DOCS[i].id === tmp){ if(d && d.id) DOCS[i].id = String(d.id); break; }
      }
      localStorage.setItem('ff_docs', JSON.stringify(DOCS));
      toast('âœ… Documento salvo!');
    }
    if(btn) btn.disabled = false;
  });
}

function delDoc(id){
  var bk = [].concat(DOCS);
  DOCS = DOCS.filter(function(d){ return String(d.id)!==String(id); });
  localStorage.setItem('ff_docs', JSON.stringify(DOCS));
  renderDocs();
  apiCall('deleteDoc', {id:id}, function(err){
    if(err){ DOCS=bk; localStorage.setItem('ff_docs',JSON.stringify(DOCS)); renderDocs(); toast('âŒ Erro ao remover','err'); }
    else toast('ğŸ—‘ï¸ Removido');
  });
}

function openDoc(url){
  window.open(url, '_blank');
}

function shareDoc(url, name){
  if(navigator.share){
    navigator.share({ title: name, url: url }).catch(function(){});
  } else {
    navigator.clipboard && navigator.clipboard.writeText(url)
      .then(function(){ toast('ğŸ“‹ Link copiado!'); })
      .catch(function(){ toast('ğŸ“‹ ' + url.substring(0,40)+'...'); });
  }
}

function syncDocs(){
  apiCall('getDocs', null, function(err, d){
    if(!err && d.ok){
      DOCS = d.data.map(function(x){
        return {
          id:       String(x.id       || Date.now()),
          name:     String(x.name     || ''),
          url:      String(x.url      || ''),
          type:     String(x.type     || 'doc'),
          pasta:    String(x.pasta    || x.group || 'Outros'),
          subpasta: String(x.subpasta || '')
        };
      });
      localStorage.setItem('ff_docs', JSON.stringify(DOCS));
      renderDocs();
    }
  });
}

function renderDocs(){
  var el = document.getElementById('docs-list');
  if(!DOCS.length){
    el.innerHTML = '<div class="docs-empty">'+
      '<div class="de-ico">ğŸ“</div>'+
      '<div class="de-title">Nenhum documento salvo</div>'+
      '<div class="de-sub">Adicione links de planilhas, documentos<br>e pastas do Google Drive para acesso rÃ¡pido.</div>'+
      '</div>';
    return;
  }

  // Estrutura 3 nÃ­veis: pasta > subpasta > [docs]
  var tree = {};
  DOCS.forEach(function(d){
    var pasta    = normKey(d.pasta    || d.group || 'Outros');
    var subpasta = normKey(d.subpasta || '');
    if(!tree[pasta]) tree[pasta] = {};
    if(!tree[pasta][subpasta]) tree[pasta][subpasta] = [];
    tree[pasta][subpasta].push(d);
  });

  // Ordenar pastas principais seguindo a ordem definida
  var pastaOrder = PASTAS_PRINCIPAIS.map(normKey);
  var allPastas = Object.keys(tree);
  var sorted = pastaOrder.filter(function(p){ return tree[p]; });
  allPastas.forEach(function(p){ if(sorted.indexOf(p)===-1) sorted.push(p); });

  var html = '';
  sorted.forEach(function(pasta){
    var subpastas = tree[pasta];
    var totalDocs = 0;
    Object.keys(subpastas).forEach(function(s){ totalDocs += subpastas[s].length; });

    var isCollapsed = COLLAPSED_PASTAS.indexOf(pasta) !== -1;
    html += '<div class="docs-pasta-block">'+
      '<div class="docs-pasta-title" data-pasta="'+esc(pasta)+'" style="cursor:pointer">'+
        '<span>'+( isCollapsed?'ğŸ“':'ğŸ“‚' )+' '+esc(pasta)+'</span>'+
        '<span class="docs-badge">'+totalDocs+'</span>'+
        '<span class="docs-pasta-chevron" style="transform:'+(isCollapsed?'rotate(-90deg)':'')+'">â–¾</span>'+
      '</div>'+
      '<div class="docs-pasta-body" style="display:'+(isCollapsed?'none':'block')+'">';

    // Subpastas ordenadas â€” sem nome primeiro, depois alfabÃ©tico
    var subKeys = Object.keys(subpastas).sort(function(a,b){
      if(!a) return -1; if(!b) return 1;
      return a.localeCompare(b,'pt');
    });

    subKeys.forEach(function(sub){
      var docs = subpastas[sub];
      if(sub){
        html += '<div class="docs-sub-title">'+
          '<span>ğŸ“ '+esc(sub)+'</span>'+
          '<span class="docs-badge">'+docs.length+'</span>'+
        '</div>';
      }

      docs.forEach(function(d){
        var meta   = DOC_ICONS[d.type] || DOC_ICONS.link;
        var safeId = String(d.id);
        var indent = sub ? 'margin-left:14px;' : '';
        html += '<div class="doc-card" data-url="'+esc(d.url)+'" data-id="'+safeId+'" style="'+indent+'">'+
          '<div class="doc-ico" style="background:'+meta.bg+'">'+meta.ico+'</div>'+
          '<div class="doc-info">'+
            '<div class="doc-name">'+esc(d.name)+'</div>'+
            '<div class="doc-meta"><span class="doc-type-tag">'+meta.label+'</span></div>'+
          '</div>'+
          '<div class="doc-actions">'+
            '<button class="doc-btn doc-share" data-url="'+esc(d.url)+'" data-name="'+esc(d.name)+'">â¬†ï¸</button>'+
            '<button class="doc-btn del doc-del" data-id="'+safeId+'">ğŸ—‘ï¸</button>'+
          '</div>'+
        '</div>';
      });
    });

    html += '</div></div>'; // /docs-pasta-body /docs-pasta-block
  });

  el.innerHTML = html;

  // Toggle colapso de pastas
  el.querySelectorAll('.docs-pasta-title').forEach(function(title){
    title.addEventListener('click', function(){
      var pasta = title.getAttribute('data-pasta');
      var idx   = COLLAPSED_PASTAS.indexOf(pasta);
      if(idx===-1) COLLAPSED_PASTAS.push(pasta);
      else         COLLAPSED_PASTAS.splice(idx,1);
      localStorage.setItem('ff_collapsed', JSON.stringify(COLLAPSED_PASTAS));
      renderDocs();
    });
  });

  el.querySelectorAll('.doc-card').forEach(function(card){
    card.addEventListener('click', function(){ openDoc(card.getAttribute('data-url')); });
  });
  el.querySelectorAll('.doc-share').forEach(function(btn){
    btn.addEventListener('click', function(e){
      e.stopPropagation();
      shareDoc(btn.getAttribute('data-url'), btn.getAttribute('data-name'));
    });
  });
  el.querySelectorAll('.doc-del').forEach(function(btn){
    btn.addEventListener('click', function(e){
      e.stopPropagation();
      delDoc(btn.getAttribute('data-id'));
    });
  });
}

function emptyHTML(icon,title,desc){
  return '<div class="empty">'+(icon?'<div class="ei">'+icon+'</div>':'')+
    (title?'<div class="et">'+title+'</div>':'')+
    (desc?'<div class="ed">'+desc+'</div>':'')+
    '</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init(){
  // Try to read saved API URL
  try{ API = localStorage.getItem('ff_api') || ''; }catch(e){ API=''; }

  if(API){
    document.getElementById('setup').style.display='none';
    boot();
  } else {
    // Show setup - already visible by default, just make sure
    document.getElementById('setup').style.display='flex';
  }
}

// Run after DOM is fully parsed
if(document.readyState === 'loading'){
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
</body>
</html>

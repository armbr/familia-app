<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FamÃ­lia App</title>
<style>
/* â”€â”€ RESET & BASE â”€â”€ */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{
  height:100%;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;
  font-size:16px;
  background:#0F1923;
  color:#EDF2F7;
}

/* â”€â”€ CSS VARS â”€â”€ */
:root{
  --bg:#0F1923;
  --bg2:#162030;
  --bg3:#1E2D40;
  --card:#1A2A3A;
  --card2:#213346;
  --border:rgba(255,255,255,0.08);
  --green:#2ECC9A;
  --green2:rgba(46,204,154,0.15);
  --red:#FF6B6B;
  --red2:rgba(255,107,107,0.15);
  --yellow:#FFD166;
  --yellow2:rgba(255,209,102,0.12);
  --blue:#5B9BD5;
  --blue2:rgba(91,155,213,0.15);
  --t1:#EDF2F7;
  --t2:#8FA8C4;
  --t3:#526680;
  --r:16px;
  --r2:12px;
}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:0;height:0}

/* â”€â”€ LAYOUT â”€â”€ */
#app{
  max-width:430px;
  min-height:100vh;
  margin:0 auto;
  background:var(--bg);
  position:relative;
  padding-bottom:80px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETUP SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#setup{
  position:fixed;
  inset:0;
  max-width:430px;
  margin:0 auto;
  background:#0F1923;
  z-index:9999;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:32px 24px;
  text-align:center;
}
#setup .ico{font-size:56px;margin-bottom:20px}
#setup h2{font-size:22px;font-weight:800;color:#EDF2F7;margin-bottom:8px}
#setup p{font-size:13px;color:#8FA8C4;margin-bottom:28px;line-height:1.6}
#setup input{
  width:100%;padding:13px 14px;
  background:#1E2D40;border:2px solid rgba(255,255,255,0.1);
  border-radius:12px;color:#EDF2F7;font-size:13px;
  font-family:inherit;outline:none;margin-bottom:10px;
  transition:border-color .2s;
}
#setup input:focus{border-color:#2ECC9A}
#setup button{
  width:100%;padding:14px;
  background:#2ECC9A;border:none;border-radius:12px;
  color:#0A1A12;font-size:15px;font-weight:800;
  font-family:inherit;cursor:pointer;margin-bottom:10px;
}
#setup .note{
  font-size:11px;color:#526680;line-height:1.7;
  background:#1E2D40;border-radius:12px;
  padding:14px;text-align:left;width:100%;
}
#setup .note b{color:#8FA8C4}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#hdr{
  position:sticky;top:0;z-index:100;
  background:var(--bg2);
  padding:16px 16px 12px;
  border-bottom:1px solid var(--border);
}
#hdr-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
#hdr-top .logo{font-size:12px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--t3)}
#hdr-top .right{display:flex;align-items:center;gap:8px}
#offline-badge{
  display:none;font-size:10px;font-weight:700;
  background:rgba(255,209,102,.12);border:1px solid rgba(255,209,102,.3);
  color:#FFD166;padding:3px 8px;border-radius:100px;
}
#month-chip{
  font-size:12px;font-weight:600;color:var(--t2);
  background:var(--card);padding:5px 11px;
  border-radius:100px;border:1px solid var(--border);
  text-transform:capitalize;
}
#sync-btn{
  background:var(--card);border:1px solid var(--border);
  color:var(--t2);font-size:12px;padding:5px 10px;
  border-radius:100px;cursor:pointer;font-family:inherit;
  font-weight:600;transition:all .2s;
}
#sync-btn.spinning{color:var(--green);border-color:var(--green);animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Balance card */
#bal{
  background:linear-gradient(135deg,#1E3A5F,#0F2438);
  border:1px solid rgba(91,155,213,.2);
  border-radius:var(--r);padding:18px;margin-bottom:14px;
}
#bal .lbl{font-size:10px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--t2);margin-bottom:5px}
#bal-val{font-size:32px;font-weight:800;letter-spacing:-1px;margin-bottom:14px}
#bal-val.neg{color:var(--red)}
#bal-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.bal-cell{background:rgba(255,255,255,.05);border-radius:10px;padding:9px 11px}
.bal-cell .bl{font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:3px}
.bl.inc{color:var(--green)}.bl.exp{color:var(--red)}
.bal-cell .bv{font-size:15px;font-weight:700}

/* Fin tabs */
#fin-tabs{display:flex;gap:5px}
.ftab{
  flex:1;padding:8px 2px;border:1px solid var(--border);
  background:var(--card);color:var(--t3);
  border-radius:10px;font-family:inherit;
  font-size:11px;font-weight:700;cursor:pointer;transition:all .2s;
}
.ftab.on{background:var(--green);color:#0A1A12;border-color:var(--green)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTENT AREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#content{padding:0 14px}
.pg{display:none}
.pg.on{display:block}

/* Section label */
.slbl{
  font-size:10px;font-weight:700;letter-spacing:1.5px;
  text-transform:uppercase;color:var(--t3);
  padding:14px 0 8px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card{
  background:var(--card);border:1px solid var(--border);
  border-radius:var(--r);padding:15px;margin-bottom:8px;
}
.card-title{font-size:12px;font-weight:700;color:var(--t2);margin-bottom:12px}
.fl{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:4px}
input,select{
  width:100%;padding:10px 12px;
  background:var(--bg3);border:1.5px solid var(--border);
  border-radius:10px;color:var(--t1);
  font-family:inherit;font-size:14px;outline:none;
  transition:border-color .2s;
  -webkit-appearance:none;appearance:none;
}
input:focus,select:focus{border-color:var(--green)}
input[type=number]{font-weight:700}
select option{background:#1A2A3A}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
.r-wrap{position:relative}
.r-wrap::before{
  content:'R$';position:absolute;left:11px;top:50%;
  transform:translateY(-50%);font-size:12px;font-weight:700;
  color:var(--t3);pointer-events:none;z-index:1;
}
.r-wrap input{padding-left:36px}
.type-row{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px}
.ttype{
  padding:9px;border:1.5px solid var(--border);border-radius:10px;
  background:transparent;color:var(--t2);
  font-family:inherit;font-size:13px;font-weight:600;
  cursor:pointer;transition:all .2s;
  display:flex;align-items:center;justify-content:center;gap:5px;
}
.ttype.exp{background:var(--red2);border-color:var(--red);color:var(--red)}
.ttype.inc{background:var(--green2);border-color:var(--green);color:var(--green)}
.btn{
  width:100%;padding:13px;border:none;border-radius:10px;
  background:var(--green);color:#0A1A12;
  font-family:inherit;font-size:14px;font-weight:800;
  cursor:pointer;margin-top:4px;transition:opacity .2s,transform .1s;
}
.btn:active{transform:scale(.98);opacity:.9}
.btn:disabled{opacity:.45;cursor:not-allowed}

/* Collapsible form header */
.coll-hdr{
  display:flex;justify-content:space-between;align-items:center;
  cursor:pointer;margin-bottom:0;
}
.coll-arrow{font-size:16px;color:var(--t3);transition:transform .2s}
.coll-body{margin-top:12px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TRANSACTION LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.txl{display:flex;flex-direction:column;gap:7px}
.txi{
  background:var(--card);border:1px solid var(--border);
  border-radius:10px;padding:12px 14px;
  display:flex;align-items:center;gap:10px;
  animation:up .2s ease both;
}
@keyframes up{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.txi-ico{
  width:38px;height:38px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:16px;flex-shrink:0;
}
.txi-ico.exp{background:var(--red2)}
.txi-ico.inc{background:var(--green2)}
.txi-info{flex:1;min-width:0}
.txi-desc{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.txi-meta{font-size:11px;color:var(--t3);display:flex;gap:5px;align-items:center}
.txi-cat{background:var(--bg3);padding:1px 6px;border-radius:4px;font-weight:600}
.txi-val{font-size:15px;font-weight:800;flex-shrink:0}
.txi-val.exp{color:var(--red)}
.txi-val.inc{color:var(--green)}
.tdel{background:none;border:none;color:var(--t3);font-size:15px;cursor:pointer;padding:3px 5px;border-radius:7px;transition:color .2s}
.tdel:hover{color:var(--red)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CATEGORY SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.catl{display:flex;flex-direction:column;gap:7px}
.cati{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:11px 13px}
.cati-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px}
.cati-name{font-size:13px;font-weight:600}
.cati-amt{font-size:13px;font-weight:800;color:var(--red)}
.bar-bg{height:4px;background:var(--bg3);border-radius:100px;overflow:hidden}
.bar-fg{height:100%;border-radius:100px;background:linear-gradient(90deg,var(--red),#FF9A9A);transition:width .4s}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MONTH FILTER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mfrow{display:flex;gap:5px;overflow-x:auto;padding:4px 0 8px}
.mfc{
  flex-shrink:0;padding:5px 13px;border:1.5px solid var(--border);
  border-radius:100px;background:transparent;color:var(--t2);
  font-family:inherit;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;
}
.mfc.on{background:var(--green2);border-color:var(--green);color:var(--green)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIEW TOGGLE (tasks + fin agenda)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.vtog{
  display:grid;grid-template-columns:repeat(4,1fr);gap:4px;
  background:var(--bg3);border-radius:10px;padding:4px;
  margin-bottom:12px;
}
.vbtn{
  padding:7px 3px;border:none;background:transparent;
  color:var(--t3);font-family:inherit;font-size:11px;
  font-weight:700;border-radius:8px;cursor:pointer;transition:all .2s;
}
.vbtn.on{background:var(--card2);color:var(--green)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALENDAR SHARED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.day-nav{
  display:flex;align-items:center;justify-content:space-between;
  background:var(--card);border:1px solid var(--border);
  border-radius:10px;padding:10px 13px;margin-bottom:10px;
}
.dnav-btn{background:none;border:none;color:var(--t2);font-size:22px;cursor:pointer;padding:2px 6px;border-radius:7px}
.dnav-lbl{text-align:center}
.dnav-date{font-size:14px;font-weight:800}
.dnav-sub{font-size:10px;color:var(--t3);margin-top:2px;letter-spacing:.5px;text-transform:uppercase}

.wnav{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.wnav-lbl{font-size:13px;font-weight:700;color:var(--t2)}
.wnav-btn{background:var(--card);border:1px solid var(--border);color:var(--t2);font-size:12px;padding:5px 11px;border-radius:8px;cursor:pointer;font-family:inherit;font-weight:600}

.wstrip{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:10px}
.wdc{display:flex;flex-direction:column;align-items:center;gap:3px}
.wdc-lbl{font-size:9px;font-weight:700;text-transform:uppercase;color:var(--t3)}
.wdc-num{
  width:28px;height:28px;border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:700;color:var(--t2);
  background:var(--bg3);cursor:pointer;transition:all .2s;
  border:1.5px solid transparent;
}
.wdc-num.today{background:var(--green2);color:var(--green);border-color:var(--green)}
.wdc-dots{display:flex;gap:2px;justify-content:center;min-height:6px}
.dot{width:4px;height:4px;border-radius:50%}

.mnav{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.mnav-lbl{font-size:14px;font-weight:800;text-transform:capitalize}
.mnav-btn{background:var(--card);border:1px solid var(--border);color:var(--t2);width:30px;height:30px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px}
.mgrid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:10px}
.mgh{font-size:9px;font-weight:700;text-transform:uppercase;color:var(--t3);text-align:center;padding:5px 0}
.mgc{
  aspect-ratio:1;border-radius:8px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  cursor:pointer;transition:all .2s;border:1.5px solid transparent;gap:1px;
}
.mgc:hover{background:var(--bg3)}
.mgc.today{background:var(--green2);border-color:var(--green)}
.mgc .mgn{font-size:11px;font-weight:700;color:var(--t2);line-height:1}
.mgc.today .mgn{color:var(--green)}
.mgc.om .mgn{color:var(--t3)}
.mgc-dots{display:flex;gap:2px;flex-wrap:wrap;justify-content:center;max-width:18px}

/* group label */
.glbl{
  font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;
  color:var(--t3);padding:12px 0 6px;display:flex;align-items:center;gap:6px;
}
.gbadge{background:var(--bg3);color:var(--t2);font-size:10px;font-weight:700;padding:1px 6px;border-radius:100px}
.g-overdue .glbl{color:var(--red)}
.g-today  .glbl{color:var(--green)}
.g-soon   .glbl{color:var(--yellow)}

/* bal mini */
.balmini{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin-bottom:10px}
.bmc{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:9px 10px;text-align:center}
.bmc-l{font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:3px}
.bmc-l.i{color:var(--green)}.bmc-l.e{color:var(--red)}.bmc-l.b{color:var(--blue)}
.bmc-v{font-size:12px;font-weight:800}
.bmc-v.pos{color:var(--green)}.bmc-v.neg{color:var(--red)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TASK CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.taski{
  background:var(--card);border:1px solid var(--border);
  border-radius:10px;padding:12px 14px;margin-bottom:7px;
  animation:up .2s ease both;
}
.taski-hdr{display:flex;align-items:flex-start;gap:9px;margin-bottom:8px}
.chk{
  width:20px;height:20px;border-radius:6px;
  border:2px solid var(--border);flex-shrink:0;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .2s;background:transparent;font-size:11px;font-weight:800;color:#0A1A12;
  margin-top:1px;
}
.chk.done{background:var(--green);border-color:var(--green)}
.tname{font-size:14px;font-weight:600;flex:1;line-height:1.4}
.tname.done{text-decoration:line-through;color:var(--t3)}
.tdel2{background:none;border:none;color:var(--t3);font-size:14px;cursor:pointer;padding:2px 4px;border-radius:6px;flex-shrink:0}
.tags{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:7px}
.tag{font-size:10px;font-weight:700;padding:2px 8px;border-radius:100px}
.tag.pend{background:var(--yellow2);color:var(--yellow)}
.tag.prog{background:var(--blue2);color:var(--blue)}
.tag.done{background:var(--green2);color:var(--green)}
.tag.pers{background:rgba(180,130,255,.12);color:#B482FF}
.tag.work{background:var(--blue2);color:var(--blue)}
.tmeta{font-size:11px;color:var(--t3);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.tmeta .ov{color:var(--red)}
.ssel{
  font-size:11px;padding:4px 9px;border-radius:7px;font-weight:600;
  background:var(--bg3);border-color:var(--border);color:var(--t1);
  cursor:pointer;width:auto;
}

/* future planner */
.fmb{margin-bottom:18px}
.fmb-title{
  font-size:13px;font-weight:800;background:var(--card2);
  border:1px solid var(--border);border-radius:10px;
  padding:9px 13px;margin-bottom:7px;
  display:flex;justify-content:space-between;align-items:center;
}
.fproj{font-size:12px;font-weight:700}
.fproj.pos{color:var(--green)}.fproj.neg{color:var(--red)}
.fwr{
  background:var(--card);border:1px solid var(--border);
  border-radius:10px;padding:9px 13px;margin-bottom:5px;
  display:flex;justify-content:space-between;align-items:center;cursor:pointer;
}
.fwl{font-size:12px;font-weight:600;color:var(--t2)}
.fwa{display:flex;gap:9px;font-size:12px;font-weight:700}
.fwa .i{color:var(--green)}.fwa .e{color:var(--red)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EMPTY STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty{text-align:center;padding:36px 16px;color:var(--t3)}
.empty .ei{font-size:38px;margin-bottom:10px}
.empty .et{font-size:14px;font-weight:600;color:var(--t2);margin-bottom:5px}
.empty .ed{font-size:12px;line-height:1.5}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#nav{
  position:fixed;bottom:0;left:50%;transform:translateX(-50%);
  width:100%;max-width:430px;
  background:var(--bg2);border-top:1px solid var(--border);
  display:flex;padding:8px 8px 12px;gap:4px;z-index:200;
}
.nb{
  flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;
  padding:7px 4px;border:none;background:none;color:var(--t3);
  font-family:inherit;font-size:10px;font-weight:700;
  letter-spacing:.3px;cursor:pointer;border-radius:10px;transition:all .2s;
}
.nb.on{color:var(--green);background:var(--green2)}
.nb .ni{font-size:19px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast{
  position:fixed;top:16px;left:50%;
  transform:translateX(-50%) translateY(-70px);
  font-weight:700;font-size:13px;
  padding:10px 18px;border-radius:100px;
  z-index:9000;transition:transform .3s cubic-bezier(.34,1.56,.64,1);
  white-space:nowrap;box-shadow:0 6px 20px rgba(0,0,0,.4);
}
#toast.ok{background:var(--green);color:#0A1A12}
#toast.err{background:var(--red);color:#fff}
#toast.show{transform:translateX(-50%) translateY(0)}

/* loader */
#loader{
  position:fixed;inset:0;background:rgba(15,25,35,.8);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:500;opacity:0;pointer-events:none;transition:opacity .2s;
}
#loader.show{opacity:1;pointer-events:all}
.sp{width:34px;height:34px;border:3px solid var(--border);border-top-color:var(--green);border-radius:50%;animation:spin .7s linear infinite;margin-bottom:10px}
#loader p{font-size:13px;color:var(--t2)}
</style>
</head>
<body>

<div id="app">

<!-- â•â• SETUP â•â• -->
<div id="setup">
  <div class="ico">ğŸ </div>
  <h2>Configurar o App</h2>
  <p>Cole a URL do seu Google Apps Script.<br>VocÃª sÃ³ precisa fazer isso uma vez.</p>
  <input id="su-url" type="url" placeholder="https://script.google.com/macros/s/...">
  <button onclick="doSetup()">Salvar e ComeÃ§ar â†’</button>
  <div class="note">
    <b>Como obter a URL:</b><br>
    1. Acesse script.google.com â†’ Novo projeto<br>
    2. Cole o cÃ³digo do arquivo Code.gs<br>
    3. Implantar â†’ Nova implantaÃ§Ã£o â†’ App da Web<br>
    4. Acesso: <b>Qualquer pessoa</b> â†’ Implantar<br>
    5. Copie a URL e cole acima
  </div>
</div>

<!-- â•â• LOADER â•â• -->
<div id="loader"><div class="sp"></div><p id="loader-msg">Carregando...</p></div>

<!-- â•â• HEADER â•â• -->
<div id="hdr" style="display:none">
  <div id="hdr-top">
    <div class="logo">ğŸ’° FamÃ­lia</div>
    <div class="right">
      <span id="offline-badge">â— offline</span>
      <div id="month-chip">â€”</div>
      <button id="sync-btn" onclick="syncAll()">â†»</button>
    </div>
  </div>

  <!-- balance (finance only) -->
  <div id="bal">
    <div class="lbl">Saldo do MÃªs</div>
    <div id="bal-val">R$ 0,00</div>
    <div id="bal-row">
      <div class="bal-cell"><div class="bl inc">â†‘ Receitas</div><div class="bv" id="bi">R$ 0,00</div></div>
      <div class="bal-cell"><div class="bl exp">â†“ Gastos</div><div class="bv" id="be">R$ 0,00</div></div>
    </div>
  </div>

  <!-- fin tabs -->
  <div id="fin-tabs">
    <button class="ftab on" onclick="ftab('add')">â•</button>
    <button class="ftab" onclick="ftab('hist')">ğŸ“‹</button>
    <button class="ftab" onclick="ftab('cat')">ğŸ“Š</button>
    <button class="ftab" onclick="ftab('agenda')">ğŸ“…</button>
  </div>
</div>

<!-- â•â• CONTENT â•â• -->
<div id="content" style="display:none">

  <!-- â”€â”€ FINANCE â”€â”€ -->
  <div id="sec-fin">

    <!-- ADD -->
    <div class="pg on" id="fp-add">
      <div class="card" style="margin-top:12px">
        <div class="card-title">âš¡ Registro rÃ¡pido</div>
        <div class="type-row">
          <button class="ttype exp" id="bt-exp" onclick="setTxType('exp')">ğŸ”´ Gasto</button>
          <button class="ttype" id="bt-inc" onclick="setTxType('inc')">ğŸŸ¢ Receita</button>
        </div>
        <div class="row2">
          <div><div class="fl">DescriÃ§Ã£o</div><input id="tx-desc" type="text" placeholder="Ex: Mercado..." maxlength="50"></div>
          <div><div class="fl">Valor</div><div class="r-wrap"><input id="tx-val" type="number" placeholder="0,00" step="0.01" min="0" inputmode="decimal"></div></div>
        </div>
        <div class="row2">
          <div>
            <div class="fl">Categoria</div>
            <select id="tx-cat">
              <option>ğŸ½ï¸ AlimentaÃ§Ã£o</option><option>ğŸš— Transporte</option>
              <option>ğŸ  Casa/Moradia</option><option>ğŸ’Š SaÃºde</option>
              <option>ğŸ“š EducaÃ§Ã£o</option><option>ğŸ‘— Roupas</option>
              <option>ğŸ® Lazer</option><option>ğŸ’¼ SalÃ¡rio</option>
              <option>ğŸ’° Extra</option><option>ğŸ“¦ Outros</option>
            </select>
          </div>
          <div><div class="fl">Data</div><input id="tx-date" type="date"></div>
        </div>
        <button class="btn" id="btn-add-tx" onclick="addTx()">Registrar âœ“</button>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="pg" id="fp-hist">
      <div class="mfrow" id="mf-row"></div>
      <div class="slbl">LanÃ§amentos</div>
      <div class="txl" id="tx-list"></div>
    </div>

    <!-- CATEGORIES -->
    <div class="pg" id="fp-cat">
      <div class="slbl">Gastos por Categoria â€” <span id="cat-month-lbl"></span></div>
      <div class="catl" id="cat-list"></div>
    </div>

    <!-- AGENDA -->
    <div class="pg" id="fp-agenda">
      <div class="vtog" style="margin-top:12px">
        <button class="vbtn on" id="fv-day"    onclick="setFinView('day')">ğŸ“… Dia</button>
        <button class="vbtn"    id="fv-week"   onclick="setFinView('week')">ğŸ—“ Sem</button>
        <button class="vbtn"    id="fv-month"  onclick="setFinView('month')">ğŸ“† MÃªs</button>
        <button class="vbtn"    id="fv-future" onclick="setFinView('future')">ğŸ”® Plan</button>
      </div>

      <div id="fvw-day">
        <div class="day-nav">
          <button class="dnav-btn" onclick="shiftFD(-1)">â€¹</button>
          <div class="dnav-lbl"><div class="dnav-date" id="fd-date"></div><div class="dnav-sub" id="fd-sub"></div></div>
          <button class="dnav-btn" onclick="shiftFD(1)">â€º</button>
        </div>
        <div class="balmini" id="fd-bal"></div>
        <div class="txl" id="fd-list"></div>
      </div>

      <div id="fvw-week" style="display:none">
        <div class="wnav">
          <button class="wnav-btn" onclick="shiftFW(-1)">â€¹ Ant</button>
          <div class="wnav-lbl" id="fw-lbl"></div>
          <button class="wnav-btn" onclick="shiftFW(1)">PrÃ³x â€º</button>
        </div>
        <div class="wstrip" id="fw-strip"></div>
        <div class="balmini" id="fw-bal"></div>
        <div class="txl" id="fw-list"></div>
      </div>

      <div id="fvw-month" style="display:none">
        <div class="mnav">
          <button class="mnav-btn" onclick="shiftFM(-1)">â€¹</button>
          <div class="mnav-lbl" id="fm-lbl"></div>
          <button class="mnav-btn" onclick="shiftFM(1)">â€º</button>
        </div>
        <div class="mgrid" id="fm-grid"></div>
        <div class="balmini" id="fm-bal"></div>
        <div class="txl" id="fm-list"></div>
      </div>

      <div id="fvw-future" style="display:none">
        <div class="slbl" style="padding-top:8px">ğŸ”® PrÃ³ximos 3 meses</div>
        <div id="future-body"></div>
      </div>
    </div>

  </div><!-- /sec-fin -->

  <!-- â”€â”€ TASKS â”€â”€ -->
  <div id="sec-task" style="display:none">

    <!-- form -->
    <div class="card" style="margin-top:12px">
      <div class="coll-hdr card-title" onclick="toggleTF()">
        <span>ğŸ“Œ Nova Tarefa</span>
        <span class="coll-arrow" id="tf-arrow">â–¾</span>
      </div>
      <div class="coll-body" id="tf-body">
        <div style="margin-bottom:8px"><div class="fl">DescriÃ§Ã£o</div><input id="t-desc" type="text" placeholder="Ex: CertidÃ£o no cartÃ³rio..." maxlength="80"></div>
        <div class="row2">
          <div><div class="fl">Tipo</div><select id="t-type"><option value="pers">ğŸ‘¤ Pessoal</option><option value="work">ğŸ’¼ Profissional</option></select></div>
          <div><div class="fl">Prazo</div><input id="t-dead" type="date"></div>
        </div>
        <div class="row2">
          <div><div class="fl">Valor (opcional)</div><div class="r-wrap"><input id="t-val" type="number" placeholder="0,00" step="0.01" min="0" inputmode="decimal"></div></div>
          <div><div class="fl">Status</div><select id="t-status"><option value="pend">â³ Pendente</option><option value="prog">ğŸ”„ Em andamento</option></select></div>
        </div>
        <button class="btn" id="btn-add-task" onclick="addTask()">Criar Tarefa âœ“</button>
      </div>
    </div>

    <!-- view toggle -->
    <div class="vtog" style="grid-template-columns:repeat(5,1fr)">
      <button class="vbtn on" id="tv-list"  onclick="setTaskView('list')">ğŸ“‹ Lista</button>
      <button class="vbtn"    id="tv-day"   onclick="setTaskView('day')">ğŸ“… Dia</button>
      <button class="vbtn"    id="tv-week"  onclick="setTaskView('week')">ğŸ—“ Sem</button>
      <button class="vbtn"    id="tv-month" onclick="setTaskView('month')">ğŸ“† MÃªs</button>
      <button class="vbtn"    id="tv-plan"  onclick="setTaskView('plan')">ğŸ”® Plan</button>
    </div>

    <!-- LIST -->
    <div id="tvw-list">
      <div id="task-open"></div>
      <div class="slbl">ConcluÃ­das</div>
      <div id="task-done"></div>
    </div>

    <!-- DAY -->
    <div id="tvw-day" style="display:none">
      <div class="day-nav">
        <button class="dnav-btn" onclick="shiftTD(-1)">â€¹</button>
        <div class="dnav-lbl"><div class="dnav-date" id="td-date"></div><div class="dnav-sub" id="td-sub"></div></div>
        <button class="dnav-btn" onclick="shiftTD(1)">â€º</button>
      </div>
      <div id="td-list"></div>
    </div>

    <!-- WEEK -->
    <div id="tvw-week" style="display:none">
      <div class="wnav">
        <button class="wnav-btn" onclick="shiftTW(-1)">â€¹ Ant</button>
        <div class="wnav-lbl" id="tw-lbl"></div>
        <button class="wnav-btn" onclick="shiftTW(1)">PrÃ³x â€º</button>
      </div>
      <div class="wstrip" id="tw-strip"></div>
      <div id="tw-list"></div>
    </div>

    <!-- MONTH -->
    <div id="tvw-month" style="display:none">
      <div class="mnav">
        <button class="mnav-btn" onclick="shiftTM(-1)">â€¹</button>
        <div class="mnav-lbl" id="tm-lbl"></div>
        <button class="mnav-btn" onclick="shiftTM(1)">â€º</button>
      </div>
      <div class="mgrid" id="tm-grid"></div>
      <div id="tm-list"></div>
    </div>

    <!-- PLAN -->
    <div id="tvw-plan" style="display:none">
      <div class="slbl" style="padding-top:8px">ğŸ”® PrÃ³ximos 90 dias</div>
      <div id="tp-body"></div>
    </div>

  </div><!-- /sec-task -->

</div><!-- /content -->

<!-- â•â• BOTTOM NAV â•â• -->
<div id="nav" style="display:none">
  <button class="nb on" id="nb-fin"  onclick="setSection('fin')"><span class="ni">ğŸ’³</span>FinanÃ§as</button>
  <button class="nb"    id="nb-task" onclick="setSection('task')"><span class="ni">âœ…</span>Tarefas</button>
</div>

<!-- â•â• TOAST â•â• -->
<div id="toast"></div>

</div><!-- /app -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var API = localStorage.getItem('ff_api') || '';
var TXS   = JSON.parse(localStorage.getItem('ff_txs')   || '[]');
var TASKS = JSON.parse(localStorage.getItem('ff_tasks') || '[]');

var curSection  = 'fin';
var curFinTab   = 'add';
var curFinView  = 'day';
var curTaskView = 'list';
var curTxType   = 'exp';
var selMonth    = '';
var tfOpen      = true;
var online      = navigator.onLine;

// calendar state
var fdDate  = today0(); // fin day
var fwStart = weekStart(new Date()); // fin week
var fmDate  = new Date(); // fin month
var tdDate  = today0(); // task day
var twStart = weekStart(new Date()); // task week
var tmDate  = new Date(); // task month

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function today0(){ var d=new Date(); d.setHours(0,0,0,0); return d; }
function ymd(d){ return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
function ymds(s){ /* normalise any date string to YYYY-MM-DD */ if(!s)return ''; var p=String(s).trim().split('-'); if(p.length!==3)return String(s).trim(); return p[0]+'-'+pad(parseInt(p[1]))+'-'+pad(parseInt(p[2])); }
function pad(n){ return String(n).padStart(2,'0'); }
function weekStart(d){
  var dt=new Date(d); var day=dt.getDay();
  var diff = day===0 ? -6 : 1-day;
  dt.setDate(dt.getDate()+diff); dt.setHours(0,0,0,0); return dt;
}
function fmtBRL(v){
  return Number(v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
}
function fmtDate(s){
  if(!s) return '';
  var p=String(s).trim().split('-');
  if(p.length!==3) return String(s);
  return pad(parseInt(p[2]))+'/'+pad(parseInt(p[1]))+'/'+p[0];
}
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function toast(msg,type){
  var t=document.getElementById('toast');
  t.textContent=msg; t.className='toast '+(type||'ok')+' show';
  setTimeout(function(){ t.classList.remove('show'); },2600);
}
function load(show,msg){
  document.getElementById('loader').classList.toggle('show',show);
  if(msg) document.getElementById('loader-msg').textContent=msg;
}
function save(){
  localStorage.setItem('ff_txs',   JSON.stringify(TXS));
  localStorage.setItem('ff_tasks', JSON.stringify(TASKS));
}
function balOf(list){
  var i=0,e=0;
  list.forEach(function(t){
    var v=parseFloat(t.value||0);
    if(t.type==='inc') i+=v; else e+=v;
  });
  return {i:i,e:e,b:i-e};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doSetup(){
  var u=document.getElementById('su-url').value.trim();
  if(!u.startsWith('https://')){toast('âš ï¸ URL invÃ¡lida','err');return;}
  API=u; localStorage.setItem('ff_api',u);
  document.getElementById('setup').style.display='none';
  boot();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function boot(){
  var now=new Date();
  selMonth=now.getFullYear()+'-'+pad(now.getMonth()+1);

  document.getElementById('month-chip').textContent=
    now.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  document.getElementById('cat-month-lbl').textContent=
    now.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});

  document.getElementById('tx-date').value = ymd(now);
  document.getElementById('t-dead').value  = ymd(now);

  document.getElementById('hdr').style.display='block';
  document.getElementById('content').style.display='block';
  document.getElementById('nav').style.display='flex';

  renderAll();
  syncAll();
}

window.addEventListener('online',  function(){ online=true;  document.getElementById('offline-badge').style.display='none'; });
window.addEventListener('offline', function(){ online=false; document.getElementById('offline-badge').style.display='inline'; });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function apiCall(action, body, cb){
  var url = API+'?action='+action;
  var opts = body
    ? {method:'POST', body:JSON.stringify(body)}
    : {method:'GET'};
  fetch(url, opts)
    .then(function(r){ return r.json(); })
    .then(function(d){ cb(null,d); })
    .catch(function(e){ cb(e); });
}

function syncAll(){
  if(!online){ toast('ğŸ“µ Offline â€” usando cache','err'); return; }
  var btn=document.getElementById('sync-btn');
  btn.classList.add('spinning'); load(true,'Sincronizando...');
  var done=0;
  function tick(){
    done++;
    if(done===2){ btn.classList.remove('spinning'); load(false); renderAll(); toast('âœ… Sincronizado!'); }
  }
  apiCall('getTransactions',null,function(err,d){
    if(!err && d.ok){ TXS=d.data; save(); } tick();
  });
  apiCall('getTasks',null,function(err,d){
    if(!err && d.ok){ TASKS=d.data; save(); } tick();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSection(s){
  curSection=s;
  document.getElementById('sec-fin').style.display  = s==='fin'  ? 'block':'none';
  document.getElementById('sec-task').style.display = s==='task' ? 'block':'none';
  document.getElementById('bal').style.display      = s==='fin'  ? 'block':'none';
  document.getElementById('fin-tabs').style.display = s==='fin'  ? 'flex' :'none';
  document.getElementById('nb-fin').classList.toggle('on',  s==='fin');
  document.getElementById('nb-task').classList.toggle('on', s==='task');
  if(s==='task') renderTasks();
}

function ftab(t){
  curFinTab=t;
  ['add','hist','cat','agenda'].forEach(function(x){
    document.getElementById('fp-'+x).classList.toggle('on', x===t);
  });
  document.querySelectorAll('.ftab').forEach(function(b,i){
    b.classList.toggle('on', ['add','hist','cat','agenda'][i]===t);
  });
  if(t==='hist')   renderHist();
  if(t==='cat')    renderCat();
  if(t==='agenda') renderFinView();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  renderBal();
  if(curFinTab==='hist')   renderHist();
  if(curFinTab==='cat')    renderCat();
  if(curFinTab==='agenda') renderFinView();
  if(curSection==='task')  renderTasks();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRANSACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTxType(t){
  curTxType=t;
  document.getElementById('bt-exp').className='ttype'+(t==='exp'?' exp':'');
  document.getElementById('bt-inc').className='ttype'+(t==='inc'?' inc':'');
  document.getElementById('tx-cat').value = t==='inc' ? 'ğŸ’¼ SalÃ¡rio':'ğŸ½ï¸ AlimentaÃ§Ã£o';
}

function addTx(){
  var desc=document.getElementById('tx-desc').value.trim();
  var val =parseFloat(document.getElementById('tx-val').value);
  var cat =document.getElementById('tx-cat').value;
  var date=document.getElementById('tx-date').value;
  if(!desc){toast('âš ï¸ Informe a descriÃ§Ã£o','err');return;}
  if(!val||val<=0){toast('âš ï¸ Informe o valor','err');return;}
  if(!date){toast('âš ï¸ Informe a data','err');return;}
  var btn=document.getElementById('btn-add-tx'); btn.disabled=true;
  var tx={type:curTxType,desc:desc,value:val,cat:cat,date:date};
  var tmp=Date.now(); TXS.unshift(Object.assign({id:tmp},tx)); renderAll();
  apiCall('addTransaction',tx,function(err){
    if(err){ TXS=TXS.filter(function(t){return t.id!==tmp;}); renderAll(); toast('âŒ Erro ao salvar','err'); }
    else{ syncAll(); toast(curTxType==='exp'?'âœ… Gasto registrado!':'âœ… Receita registrada!'); }
    btn.disabled=false;
  });
  document.getElementById('tx-desc').value='';
  document.getElementById('tx-val').value='';
}

function delTx(id){
  var bk=[].concat(TXS);
  TXS=TXS.filter(function(t){return String(t.id)!==String(id);}); renderAll();
  apiCall('deleteTransaction',{id:id},function(err){
    if(err){TXS=bk;renderAll();toast('âŒ Erro ao remover','err');}
    else toast('ğŸ—‘ï¸ Removido');
  });
}

function filteredTxs(){
  return TXS.filter(function(t){return ymds(t.date).startsWith(selMonth);});
}

function renderBal(){
  var b=balOf(filteredTxs());
  var v=document.getElementById('bal-val');
  v.textContent=fmtBRL(b.b);
  v.className=b.b<0?'neg':'';
  document.getElementById('bi').textContent=fmtBRL(b.i);
  document.getElementById('be').textContent=fmtBRL(b.e);
}

function renderHist(){
  var months=[...new Set(TXS.map(function(t){return ymds(t.date).substring(0,7);}))].sort().reverse();
  var mf=document.getElementById('mf-row');
  mf.innerHTML=months.map(function(m){
    var p=m.split('-');
    var lbl=new Date(p[0],parseInt(p[1])-1,1).toLocaleDateString('pt-BR',{month:'short',year:'2-digit'});
    return '<button class="mfc'+(m===selMonth?' on':'')+ '" onclick="selMon(\''+m+'\')">'+lbl+'</button>';
  }).join('');
  var txs=filteredTxs();
  var el=document.getElementById('tx-list');
  if(!txs.length){el.innerHTML=emptyHTML('ğŸ“­','Nenhum lanÃ§amento','Nenhum registro neste perÃ­odo');return;}
  el.innerHTML=txs.map(txCard).join('');
}

function selMon(m){
  selMonth=m;
  var p=m.split('-');
  document.getElementById('cat-month-lbl').textContent=
    new Date(p[0],parseInt(p[1])-1,1).toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  renderAll();
  if(curFinTab!=='hist') ftab('hist');
}

function renderCat(){
  var txs=filteredTxs().filter(function(t){return t.type==='exp';});
  var el=document.getElementById('cat-list');
  if(!txs.length){el.innerHTML=emptyHTML('ğŸ“Š','Sem gastos','Adicione gastos para ver o resumo');return;}
  var bc={};
  txs.forEach(function(t){bc[t.cat]=(bc[t.cat]||0)+parseFloat(t.value||0);});
  var total=Object.values(bc).reduce(function(a,b){return a+b;},0);
  var sorted=Object.entries(bc).sort(function(a,b){return b[1]-a[1];});
  el.innerHTML=sorted.map(function(x){
    var pct=Math.round(x[1]/total*100);
    return '<div class="cati"><div class="cati-hdr"><div class="cati-name">'+x[0]+'</div><div class="cati-amt">-'+fmtBRL(x[1])+'</div></div><div class="bar-bg"><div class="bar-fg" style="width:'+pct+'%"></div></div></div>';
  }).join('');
}

function txCard(t){
  return '<div class="txi"><div class="txi-ico '+t.type+'">'+(t.type==='exp'?'ğŸ”´':'ğŸŸ¢')+'</div><div class="txi-info"><div class="txi-desc">'+esc(t.desc)+'</div><div class="txi-meta"><span class="txi-cat">'+esc(t.cat)+'</span><span>'+fmtDate(t.date)+'</span></div></div><div class="txi-val '+t.type+'">'+(t.type==='exp'?'-':'+' )+fmtBRL(parseFloat(t.value))+'</div><button class="tdel" onclick="delTx(\''+t.id+'\')">ğŸ—‘ï¸</button></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FINANCE CALENDAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setFinView(v){
  curFinView=v;
  ['day','week','month','future'].forEach(function(x){
    document.getElementById('fvw-'+x).style.display = x===v?'block':'none';
    document.getElementById('fv-'+x).classList.toggle('on', x===v);
  });
  renderFinView();
}

function renderFinView(){
  if(curFinView==='day')    renderFD();
  if(curFinView==='week')   renderFW();
  if(curFinView==='month')  renderFM();
  if(curFinView==='future') renderFuture();
}

function txsOn(d){ var target=ymd(d); return TXS.filter(function(t){return ymds(t.date)===target;}); }
function txsIn(from,to){ return TXS.filter(function(t){var d=ymds(t.date);return d>=from&&d<=to;}); }

function balMini(id,b){
  document.getElementById(id).innerHTML=
    '<div class="bmc"><div class="bmc-l i">â†‘ Receitas</div><div class="bmc-v pos">'+fmtBRL(b.i)+'</div></div>'+
    '<div class="bmc"><div class="bmc-l e">â†“ Gastos</div><div class="bmc-v neg">'+fmtBRL(b.e)+'</div></div>'+
    '<div class="bmc"><div class="bmc-l b">= Saldo</div><div class="bmc-v '+(b.b>=0?'pos':'neg')+'">'+fmtBRL(b.b)+'</div></div>';
}

function groupedTxHTML(txs){
  if(!txs.length) return emptyHTML('ğŸ’¸','Nenhum lanÃ§amento','Nenhuma transaÃ§Ã£o neste perÃ­odo');
  var byD={};
  txs.forEach(function(t){ var d=ymds(t.date); if(!byD[d])byD[d]=[]; byD[d].push(t); });
  var tod=ymd(new Date());
  return Object.keys(byD).sort().reverse().map(function(d){
    var p=d.split('-');
    var lbl=new Date(p[0],parseInt(p[1])-1,parseInt(p[2])).toLocaleDateString('pt-BR',{weekday:'short',day:'numeric',month:'short'});
    var isT=d===tod;
    return '<div class="glbl'+(isT?' g-today':'')+'">'+( isT?'â˜€ï¸ ':'' )+lbl+' <span class="gbadge">'+byD[d].length+'</span></div>'+byD[d].map(txCard).join('');
  }).join('');
}

// FIN DAY
function renderFD(){
  var tod=ymd(new Date()); var d=ymd(fdDate); var isT=d===tod;
  document.getElementById('fd-date').textContent=isT
    ?'Hoje, '+fdDate.toLocaleDateString('pt-BR',{day:'numeric',month:'long'})
    :fdDate.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long'});
  document.getElementById('fd-sub').textContent=isT?'â˜€ï¸ hoje':fdDate.getFullYear();
  var txs=txsOn(fdDate); var b=balOf(txs); balMini('fd-bal',b);
  document.getElementById('fd-list').innerHTML=txs.length
    ?txs.map(txCard).join('')
    :emptyHTML('ğŸ’¸','Nenhum lanÃ§amento neste dia','');
}
function shiftFD(n){ fdDate.setDate(fdDate.getDate()+n); renderFD(); }

// FIN WEEK
function renderFW(){
  var days=['Seg','Ter','Qua','Qui','Sex','SÃ¡b','Dom'];
  var tod=ymd(new Date());
  var we=new Date(fwStart); we.setDate(we.getDate()+6);
  document.getElementById('fw-lbl').textContent=
    fwStart.toLocaleDateString('pt-BR',{day:'numeric',month:'short'})+' â€“ '+
    we.toLocaleDateString('pt-BR',{day:'numeric',month:'short'});
  var dates=[]; var stripH='';
  for(var i=0;i<7;i++){
    var d=new Date(fwStart); d.setDate(d.getDate()+i);
    var dy=ymd(d); dates.push(dy);
    var dayTxs=txsOn(d);
    var hasI=dayTxs.some(function(t){return t.type==='inc';});
    var hasE=dayTxs.some(function(t){return t.type==='exp';});
    stripH+='<div class="wdc"><div class="wdc-lbl">'+days[i]+'</div>'+
      '<div class="wdc-num'+(dy===tod?' today':'')+'" onclick="finWkDay(\''+dy+'\')">'+d.getDate()+'</div>'+
      '<div class="wdc-dots">'+(hasI?'<div class="dot" style="background:var(--green)"></div>':'')+
      (hasE?'<div class="dot" style="background:var(--red)"></div>':'')+'</div></div>';
  }
  document.getElementById('fw-strip').innerHTML=stripH;
  var allTxs=txsIn(dates[0],dates[6]);
  balMini('fw-bal',balOf(allTxs));
  document.getElementById('fw-list').innerHTML=groupedTxHTML(allTxs);
}
function shiftFW(n){ fwStart.setDate(fwStart.getDate()+n*7); renderFW(); }
function finWkDay(d){ fdDate=new Date(d+'T00:00:00'); setFinView('day'); }

// FIN MONTH
function renderFM(){
  var yr=fmDate.getFullYear(); var mo=fmDate.getMonth();
  var tod=ymd(new Date());
  document.getElementById('fm-lbl').textContent=
    fmDate.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  var dh=['Seg','Ter','Qua','Qui','Sex','SÃ¡b','Dom'];
  var gh=dh.map(function(d){return '<div class="mgh">'+d+'</div>';}).join('');
  var fd=new Date(yr,mo,1); var ld=new Date(yr,mo+1,0);
  var off=fd.getDay()-1; if(off<0)off=6;
  var rows=Math.ceil((off+ld.getDate())/7);
  for(var i=0;i<rows*7;i++){
    var dn=i-off+1;
    if(dn<1||dn>ld.getDate()){gh+='<div class="mgc om"><div class="mgn"></div></div>';continue;}
    var d=new Date(yr,mo,dn); var dy=ymd(d);
    var isT=dy===tod;
    var dTxs=txsOn(d);
    var hasI=dTxs.some(function(t){return t.type==='inc';});
    var hasE=dTxs.some(function(t){return t.type==='exp';});
    gh+='<div class="mgc'+(isT?' today':'')+'" onclick="finMoDay(\''+dy+'\')">'+
      '<div class="mgn">'+dn+'</div>'+
      '<div class="mgc-dots">'+
      (hasI?'<div class="dot" style="background:var(--green)"></div>':'')+
      (hasE?'<div class="dot" style="background:var(--red)"></div>':'')+
      '</div></div>';
  }
  document.getElementById('fm-grid').innerHTML=gh;
  var ms=yr+'-'+pad(mo+1);
  var moTxs=TXS.filter(function(t){return ymds(t.date).startsWith(ms);}).sort(function(a,b){return ymds(a.date).localeCompare(ymds(b.date));});
  balMini('fm-bal',balOf(moTxs));
  document.getElementById('fm-list').innerHTML=groupedTxHTML(moTxs);
}
function shiftFM(n){ fmDate.setMonth(fmDate.getMonth()+n); renderFM(); }
function finMoDay(d){ fdDate=new Date(d+'T00:00:00'); setFinView('day'); }

// FUTURE
function renderFuture(){
  var now=new Date(); var html='';
  for(var mOff=0;mOff<3;mOff++){
    var d=new Date(now.getFullYear(),now.getMonth()+mOff,1);
    var yr=d.getFullYear(); var mo=d.getMonth();
    var ms=yr+'-'+pad(mo+1);
    var mTxs=TXS.filter(function(t){return ymds(t.date).startsWith(ms);});
    var b=balOf(mTxs);
    var isCur=mOff===0;
    var projI=0,projE=0;
    if(!isCur){
      var past=[];
      for(var p=1;p<=2;p++){
        var pd=new Date(now.getFullYear(),now.getMonth()-p,1);
        var ps=pd.getFullYear()+'-'+pad(pd.getMonth()+1);
        var ptx=TXS.filter(function(t){return ymds(t.date).startsWith(ps);});
        if(ptx.length) past.push(balOf(ptx));
      }
      if(past.length){
        projI=past.reduce(function(s,x){return s+x.i;},0)/past.length;
        projE=past.reduce(function(s,x){return s+x.e;},0)/past.length;
      }
    }
    var saldo=isCur?b.b:(projI-projE);
    var ld=new Date(yr,mo+1,0).getDate();
    var whtml='';
    for(var day=1;day<=ld;day+=7){
      var wEnd=Math.min(day+6,ld);
      var from=yr+'-'+pad(mo+1)+'-'+pad(day);
      var to=yr+'-'+pad(mo+1)+'-'+pad(wEnd);
      var wTxs=txsIn(from,to); var wb=balOf(wTxs);
      whtml+='<div class="fwr" onclick="finWkDay(\''+from+'\')">'+
        '<div class="fwl">'+pad(day)+'/'+pad(mo+1)+' â€“ '+pad(wEnd)+'/'+pad(mo+1)+'</div>'+
        '<div class="fwa">'+
        (wTxs.length
          ?'<span class="i">+'+fmtBRL(wb.i)+'</span><span class="e">-'+fmtBRL(wb.e)+'</span>'
          :'<span style="color:var(--t3);font-size:11px">sem dados</span>')+
        '</div></div>';
    }
    html+='<div class="fmb">'+
      '<div class="fmb-title"><span>'+(isCur?'â˜€ï¸ ':'')+d.toLocaleDateString('pt-BR',{month:'long',year:'numeric'})+'</span>'+
      '<span class="fproj '+(saldo>=0?'pos':'neg')+'">'+(isCur?'':' ~ ')+fmtBRL(Math.abs(saldo))+' '+(saldo>=0?'sobra':'dÃ©ficit')+'</span></div>'+
      whtml+'</div>';
  }
  document.getElementById('future-body').innerHTML=html||emptyHTML('ğŸ”®','Sem dados','Adicione transaÃ§Ãµes para ver a projeÃ§Ã£o');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TASKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleTF(){
  tfOpen=!tfOpen;
  document.getElementById('tf-body').style.display=tfOpen?'block':'none';
  document.getElementById('tf-arrow').style.transform=tfOpen?'':'rotate(-90deg)';
}

function addTask(){
  var desc=document.getElementById('t-desc').value.trim();
  var type=document.getElementById('t-type').value;
  var dead=document.getElementById('t-dead').value;
  var val =parseFloat(document.getElementById('t-val').value)||null;
  var stat=document.getElementById('t-status').value;
  if(!desc){toast('âš ï¸ Informe a descriÃ§Ã£o','err');return;}
  var btn=document.getElementById('btn-add-task'); btn.disabled=true;
  var task={desc:desc,type:type,deadline:dead,value:val,status:stat};
  var tmp=Date.now(); TASKS.unshift(Object.assign({id:tmp},task)); renderTasks();
  apiCall('addTask',task,function(err){
    if(err){TASKS=TASKS.filter(function(t){return t.id!==tmp;});renderTasks();toast('âŒ Erro ao criar','err');}
    else{syncAll();toast('ğŸ“Œ Tarefa criada!');}
    btn.disabled=false;
  });
  document.getElementById('t-desc').value='';
  document.getElementById('t-val').value='';
  document.getElementById('t-status').value='pend';
}

function toggleTask(id){
  var t=TASKS.find(function(x){return String(x.id)===String(id);});
  if(!t)return;
  var ns=t.status==='done'?'pend':'done';
  t.status=ns; renderTasks();
  apiCall('updateTask',{id:id,status:ns},function(err){
    if(err){t.status=ns==='done'?'pend':'done';renderTasks();toast('âŒ Erro','err');}
    else toast(ns==='done'?'âœ… ConcluÃ­da!':'ğŸ”„ Reaberta');
  });
}

function chgTaskStatus(id,s){
  var t=TASKS.find(function(x){return String(x.id)===String(id);});
  if(!t)return; var old=t.status; t.status=s; renderTasks();
  apiCall('updateTask',{id:id,status:s},function(err){
    if(err){t.status=old;renderTasks();toast('âŒ Erro','err');}
  });
}

function delTask(id){
  var bk=[].concat(TASKS);
  TASKS=TASKS.filter(function(t){return String(t.id)!==String(id);}); renderTasks();
  apiCall('deleteTask',{id:id},function(err){
    if(err){TASKS=bk;renderTasks();toast('âŒ Erro','err');}
    else toast('ğŸ—‘ï¸ Removida');
  });
}

function setTaskView(v){
  curTaskView=v;
  ['list','day','week','month','plan'].forEach(function(x){
    document.getElementById('tvw-'+x).style.display=x===v?'block':'none';
    document.getElementById('tv-'+x).classList.toggle('on',x===v);
  });
  renderTasks();
}

function renderTasks(){
  if(curTaskView==='list')  renderTL();
  if(curTaskView==='day')   renderTD();
  if(curTaskView==='week')  renderTW();
  if(curTaskView==='month') renderTM();
  if(curTaskView==='plan')  renderTP();
}

function taskCard(t,wrap){
  var done=t.status==='done';
  var stag=done?'<span class="tag done">âœ… ConcluÃ­do</span>'
    :t.status==='prog'?'<span class="tag prog">ğŸ”„ Em andamento</span>'
    :'<span class="tag pend">â³ Pendente</span>';
  var ttag=t.type==='work'?'<span class="tag work">ğŸ’¼ Profissional</span>':'<span class="tag pers">ğŸ‘¤ Pessoal</span>';
  var tod=ymd(new Date());
  var ov=t.deadline&&ymds(t.deadline)<tod&&!done;
  var dead=t.deadline?'<span class="'+(ov?'ov':'')+'">ğŸ“… '+fmtDate(t.deadline)+(ov?' âš ï¸':'')+'</span>':'';
  var html='<div class="taski'+(wrap?' '+wrap:'')+'">'+
    '<div class="taski-hdr">'+
    '<div class="chk'+(done?' done':'')+'" onclick="toggleTask(\''+t.id+'\')">'+(done?'âœ“':'')+'</div>'+
    '<div class="tname'+(done?' done':'')+'">'+esc(t.desc)+'</div>'+
    '<button class="tdel2" onclick="delTask(\''+t.id+'\')">ğŸ—‘ï¸</button>'+
    '</div>'+
    '<div class="tags">'+stag+ttag+'</div>'+
    '<div class="tmeta">'+dead+
    (t.value?'<span>ğŸ’° '+fmtBRL(parseFloat(t.value))+'</span>':'')+
    (!done?'<select class="ssel" onchange="chgTaskStatus(\''+t.id+'\',this.value)">'+
      '<option value="pend"'+(t.status==='pend'?' selected':'')+'>â³ Pendente</option>'+
      '<option value="prog"'+(t.status==='prog'?' selected':'')+'>ğŸ”„ Em andamento</option>'+
      '<option value="done">âœ… ConcluÃ­do</option>'+
      '</select>':'')+
    '</div></div>';
  return html;
}

// LIST VIEW
function renderTL(){
  var tod=ymd(new Date());
  var open=TASKS.filter(function(t){return t.status!=='done';});
  var done=TASKS.filter(function(t){return t.status==='done';});
  var ov=open.filter(function(t){return t.deadline&&ymds(t.deadline)<tod;});
  var tdy=open.filter(function(t){return ymds(t.deadline)===tod;});
  var soon=open.filter(function(t){return t.deadline&&ymds(t.deadline)>tod;});
  var nd=open.filter(function(t){return !t.deadline;});
  var h='';
  if(ov.length)   h+='<div class="glbl g-overdue">âš ï¸ Atrasadas <span class="gbadge">'+ov.length+'</span></div>'+ov.map(function(t){return taskCard(t);}).join('');
  if(tdy.length)  h+='<div class="glbl g-today">â˜€ï¸ Hoje <span class="gbadge">'+tdy.length+'</span></div>'+tdy.map(function(t){return taskCard(t);}).join('');
  if(soon.length) h+='<div class="glbl g-soon">ğŸ“… PrÃ³ximas <span class="gbadge">'+soon.length+'</span></div>'+soon.map(function(t){return taskCard(t);}).join('');
  if(nd.length)   h+='<div class="glbl">ğŸ“Œ Sem prazo <span class="gbadge">'+nd.length+'</span></div>'+nd.map(function(t){return taskCard(t);}).join('');
  if(!open.length)h=emptyHTML('ğŸ‰','Tudo em dia!','Nenhuma tarefa em aberto');
  document.getElementById('task-open').innerHTML=h;
  document.getElementById('task-done').innerHTML=done.length
    ?done.slice(0,10).map(function(t){return taskCard(t);}).join('')
    :emptyHTML('','Nenhuma concluÃ­da ainda','');
}

// TASK DAY
function renderTD(){
  var tod=ymd(new Date()); var d=ymd(tdDate); var isT=d===tod;
  document.getElementById('td-date').textContent=isT
    ?'Hoje, '+tdDate.toLocaleDateString('pt-BR',{day:'numeric',month:'long'})
    :tdDate.toLocaleDateString('pt-BR',{weekday:'long',day:'numeric',month:'long'});
  document.getElementById('td-sub').textContent=isT?'â˜€ï¸ hoje':tdDate.toLocaleDateString('pt-BR',{year:'numeric'});
  var tasks=TASKS.filter(function(t){return ymds(t.deadline)===d;});
  document.getElementById('td-list').innerHTML=tasks.length
    ?tasks.map(function(t){return taskCard(t);}).join('')
    :emptyHTML('âœ¨','Nenhuma tarefa neste dia','Crie uma tarefa com prazo em '+fmtDate(d));
}
function shiftTD(n){ tdDate.setDate(tdDate.getDate()+n); renderTD(); }

// TASK WEEK
function renderTW(){
  var days=['Seg','Ter','Qua','Qui','Sex','SÃ¡b','Dom'];
  var tod=ymd(new Date());
  var we=new Date(twStart); we.setDate(we.getDate()+6);
  document.getElementById('tw-lbl').textContent=
    twStart.toLocaleDateString('pt-BR',{day:'numeric',month:'short'})+' â€“ '+
    we.toLocaleDateString('pt-BR',{day:'numeric',month:'short'});
  var dates=[]; var sh=''; var total=0;
  for(var i=0;i<7;i++){
    var d=new Date(twStart); d.setDate(d.getDate()+i);
    var dy=ymd(d); dates.push(dy);
    var has=TASKS.some(function(t){return ymds(t.deadline)===dy;});
    sh+='<div class="wdc"><div class="wdc-lbl">'+days[i]+'</div>'+
      '<div class="wdc-num'+(dy===tod?' today':'')+'" onclick="taskWkDay(\''+dy+'\')">'+d.getDate()+'</div>'+
      '<div class="wdc-dots">'+(has?'<div class="dot" style="background:var(--yellow)"></div>':'')+'</div></div>';
  }
  document.getElementById('tw-strip').innerHTML=sh;
  var h='';
  dates.forEach(function(dy){
    var dt=TASKS.filter(function(t){return ymds(t.deadline)===dy;});
    if(!dt.length)return; total+=dt.length;
    var p=dy.split('-');
    var lbl=new Date(p[0],parseInt(p[1])-1,parseInt(p[2])).toLocaleDateString('pt-BR',{weekday:'short',day:'numeric',month:'short'});
    var isT=dy===tod;
    h+='<div class="glbl'+(isT?' g-today':'')+'">'+( isT?'â˜€ï¸ ':'')+lbl+' <span class="gbadge">'+dt.length+'</span></div>'+dt.map(function(t){return taskCard(t);}).join('');
  });
  if(!total) h=emptyHTML('ğŸ“…','Semana livre!','Nenhuma tarefa com prazo nesta semana');
  document.getElementById('tw-list').innerHTML=h;
}
function shiftTW(n){ twStart.setDate(twStart.getDate()+n*7); renderTW(); }
function taskWkDay(d){ tdDate=new Date(d+'T00:00:00'); setTaskView('day'); }

// TASK MONTH
function renderTM(){
  var yr=tmDate.getFullYear(); var mo=tmDate.getMonth();
  var tod=ymd(new Date());
  document.getElementById('tm-lbl').textContent=
    tmDate.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
  var dh=['Seg','Ter','Qua','Qui','Sex','SÃ¡b','Dom'];
  var gh=dh.map(function(d){return '<div class="mgh">'+d+'</div>';}).join('');
  var fd=new Date(yr,mo,1); var ld=new Date(yr,mo+1,0);
  var off=fd.getDay()-1; if(off<0)off=6;
  var rows=Math.ceil((off+ld.getDate())/7);
  for(var i=0;i<rows*7;i++){
    var dn=i-off+1;
    if(dn<1||dn>ld.getDate()){gh+='<div class="mgc om"><div class="mgn"></div></div>';continue;}
    var d=new Date(yr,mo,dn); var dy=ymd(d);
    var isT=dy===tod;
    var dTasks=TASKS.filter(function(t){return ymds(t.deadline)===dy&&t.status!=='done';});
    var dots=dTasks.slice(0,3).map(function(t){
      var c=t.status==='done'?'var(--green)':t.status==='prog'?'var(--blue)':'var(--yellow)';
      return '<div class="dot" style="background:'+c+'"></div>';
    }).join('');
    gh+='<div class="mgc'+(isT?' today':'')+'" onclick="taskMoDay(\''+dy+'\')">'+
      '<div class="mgn">'+dn+'</div>'+
      '<div class="mgc-dots">'+dots+'</div></div>';
  }
  document.getElementById('tm-grid').innerHTML=gh;
  var ms=yr+'-'+pad(mo+1);
  var moTasks=TASKS.filter(function(t){return t.deadline&&ymds(t.deadline).startsWith(ms)&&t.status!=='done';}).sort(function(a,b){return String(a.deadline).localeCompare(String(b.deadline));});
  var h='';
  if(moTasks.length){
    var fd2=new Date(yr,mo,1);
    var byW={};
    moTasks.forEach(function(t){
      var dd=new Date(t.deadline+'T00:00:00');
      var w=Math.ceil((dd.getDate()+fd2.getDay()-1)/7);
      if(!byW[w])byW[w]=[]; byW[w].push(t);
    });
    Object.entries(byW).forEach(function(e){
      h+='<div class="glbl g-soon">Semana '+e[0]+' <span class="gbadge">'+e[1].length+'</span></div>'+e[1].map(function(t){return taskCard(t);}).join('');
    });
  } else {
    h=emptyHTML('ğŸ“†','Nenhuma tarefa neste mÃªs','');
  }
  document.getElementById('tm-list').innerHTML=h;
}
function shiftTM(n){ tmDate.setMonth(tmDate.getMonth()+n); renderTM(); }
function taskMoDay(d){ tdDate=new Date(d+'T00:00:00'); setTaskView('day'); }

// TASK PLAN â€” prÃ³ximos 90 dias agrupado por semana e mÃªs
function renderTP(){
  var now=new Date(); now.setHours(0,0,0,0);
  var html='';

  for(var mOff=0;mOff<3;mOff++){
    var mDate=new Date(now.getFullYear(), now.getMonth()+mOff, 1);
    var yr=mDate.getFullYear(); var mo=mDate.getMonth();
    var ms=yr+'-'+pad(mo+1);
    var ld=new Date(yr,mo+1,0).getDate();
    var isCur=mOff===0;

    // tarefas do mÃªs
    var moTasks=TASKS.filter(function(t){
      return t.deadline && ymds(t.deadline).startsWith(ms) && t.status!=='done';
    });
    var doneCount=TASKS.filter(function(t){
      return t.deadline && ymds(t.deadline).startsWith(ms) && t.status==='done';
    }).length;
    var totalCount=moTasks.length+doneCount;

    var mLabel=mDate.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});
    var summary=moTasks.length+' pendente'+(moTasks.length!==1?'s':'')+
      (doneCount?' Â· '+doneCount+' concluÃ­da'+(doneCount!==1?'s':''):'');

    // cabeÃ§alho do mÃªs
    html+='<div class="fmb">'+
      '<div class="fmb-title">'+
      '<span>'+(isCur?'â˜€ï¸ ':'')+mLabel+'</span>'+
      '<span style="font-size:11px;color:var(--t2)">'+summary+'</span>'+
      '</div>';

    // semanas do mÃªs
    var whtml='';
    var wNum=1;
    for(var day=1;day<=ld;day+=7){
      var wEnd=Math.min(day+6,ld);
      var from=yr+'-'+pad(mo+1)+'-'+pad(day);
      var to=yr+'-'+pad(mo+1)+'-'+pad(wEnd);

      // sÃ³ mostrar semanas a partir de hoje no mÃªs atual
      if(isCur && to < ymd(now)) { wNum++; continue; }

      var wTasks=TASKS.filter(function(t){
        var d=ymds(t.deadline);
        return t.deadline && d>=from && d<=to && t.status!=='done';
      });
      var wDone=TASKS.filter(function(t){
        var d=ymds(t.deadline);
        return t.deadline && d>=from && d<=to && t.status==='done';
      }).length;

      var dayLabel=pad(day)+'/'+pad(mo+1)+' â€“ '+pad(wEnd)+'/'+pad(mo+1);
      var hasOv=wTasks.some(function(t){ return ymds(t.deadline)<ymd(now); });

      // cabeÃ§alho da semana â€” clicÃ¡vel para ir para view semana
      whtml+='<div class="fwr" onclick="taskWkFrom(''+from+'')" style="'+(hasOv?'border-color:rgba(255,107,107,.3)':'')+'">'+
        '<div class="fwl">'+dayLabel+'</div>'+
        '<div class="fwa">'+
        (wTasks.length||wDone
          ?'<span style="color:var(--yellow)">'+wTasks.length+' pendente'+(wTasks.length!==1?'s':'')+'</span>'+
           (wDone?'<span style="color:var(--green)">'+wDone+' âœ…</span>':'')
          :'<span style="color:var(--t3);font-size:11px">sem tarefas</span>')+
        '</div></div>';

      // listar tarefas desta semana expandidas (sÃ³ mÃªs atual / prÃ³xima semana)
      if(wTasks.length && mOff<=1){
        whtml+=wTasks.map(function(t){return taskCard(t);}).join('');
      }
      wNum++;
    }

    html+=whtml+'</div>';
  }

  document.getElementById('tp-body').innerHTML = html ||
    emptyHTML('ğŸ”®','Sem tarefas planejadas','Crie tarefas com prazo para ver o planejamento');
}

function taskWkFrom(from){
  twStart=new Date(from+'T00:00:00');
  setTaskView('week');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EMPTY HTML
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function emptyHTML(icon,title,desc){
  return '<div class="empty">'+(icon?'<div class="ei">'+icon+'</div>':'')+
    (title?'<div class="et">'+title+'</div>':'')+
    (desc?'<div class="ed">'+desc+'</div>':'')+
    '</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if(API){
  document.getElementById('setup').style.display='none';
  boot();
}
</script>
</body>
</html>
